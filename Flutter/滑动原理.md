# æ€»è§ˆ
å¤§å¤šæ•°æ§ä»¶æ˜¯ä¸èƒ½æ»‘åŠ¨çš„ï¼Œå®ƒä»¬åŸºæœ¬éƒ½æ˜¯é€šè¿‡çˆ¶çº§ä¼ ç»™å­çº§`BoxConstraint`ï¼Œå­çº§é€šè¿‡`BoxConstraint`çš„å®½é«˜çº¦æŸä¿¡æ¯å’Œæ›´ä¸‹ä¸€çº§çš„å­çº§æ¥ç¡®å®š`size`ï¼Œå¹¶é€šè¿‡`offset`æ¥ç¡®å®šä½ç½®ã€‚è€Œå¯æ»‘åŠ¨çš„æ§ä»¶ï¼ŒFlutterä½¿ç”¨äº†ä¸åŒçš„è®¾è®¡æ¥å®ç°ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªå¯ä»¥æ»šåŠ¨çš„ç»„ä»¶ï¼Œéœ€è¦3ä¸ªæ–¹é¢ï¼š
1. äº¤äº’å±‚è´Ÿè´£æ£€æµ‹ç”¨æˆ·æ‰‹åŠ¿ï¼Œä¹Ÿå°±æ˜¯ `Scrollable`
2. å­˜å‚¨æˆ‘ä»¬æƒ³è¦æ»šåŠ¨çš„æ‰€æœ‰å¯¹è±¡çš„å®¹å™¨ï¼Œå¯¹åº” `ViewPort`ï¼Œæ˜¯ `MultiChildRenderObjectWidget` çš„å­ç±»
3. æä¾›å®é™…çš„ç°å®å†…å®¹ï¼Œä¹Ÿå°±æ˜¯`Sliver`ï¼ŒSliveræ˜¯ä¸€ç³»åˆ—çš„ç»„ä»¶ç±»å‹ï¼Œå¯ä»¥æ˜¯å•ä¸ªwidget(`SliverAppBar`/`SliverPadding`/`SliverPersistentHeader`/`SliverToBoxAdapter`ç­‰ç­‰)ä¹Ÿå¯ä»¥æ˜¯widgetåˆ—è¡¨(`SliverList`/`SliverGrid`)

```
ç”¨æˆ·è§¦æ‘¸/æ»šè½®äº‹ä»¶
    â†“
Scrollable (å¯æ»šåŠ¨éƒ¨ä»¶)         â† å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œç®¡ç†æ»šåŠ¨çŠ¶æ€
    â†“  
Viewport (è§†å£)                â† å®šä¹‰å¯è§åŒºåŸŸï¼Œç®¡ç†å­ç»„ä»¶å¸ƒå±€  
    â†“
Sliver                        â† å®é™…å†…å®¹ï¼ŒæŒ‰éœ€æ„å»ºå’Œå¸ƒå±€
    â†“  
RenderSliver (æ¸²æŸ“å¯¹è±¡)         â† å®é™…æ¸²æŸ“
```
`Sliver` æ˜¯ä¸“é—¨ä¸ºæ»šåŠ¨è®¾è®¡çš„ç‰¹æ®Š RenderObject


## Scrollable
æˆ‘ä»¬å¸¸ç”¨çš„`ListView`ã€`GridView`éƒ½æ˜¯`ScrollView`çš„å­ç±»ï¼Œåœ¨`ScrollView`çš„`build`æ–¹æ³•ä¸­å°±ä½¿ç”¨äº†`Scrollable`ã€‚

```dart
class Scrollable extends StatefulWidget {
  const Scrollable({
    super.key,
    this.axisDirection = AxisDirection.down, // æ»šåŠ¨æ–¹å‘ï¼Œé»˜è®¤æ˜¯æœä¸‹çºµå‘æ»‘åŠ¨ï¼ˆå†…å®¹æœ¬èº«æœä¸Šæ»‘åŠ¨ï¼‰
    this.controller, // æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ ScrollController
    this.physics, // æ»šåŠ¨ç‰©ç†æ•ˆæœï¼Œæ¯”å¦‚iOSæ»‘åŠ¨åˆ°è¾¹ç•Œæœ‰å›å¼¹æ•ˆæœï¼Œä»¥åŠæƒ¯æ€§æ»‘åŠ¨ç­‰æ•ˆæœï¼Œéƒ½å±äºå®ƒç®¡ç†
    required this.viewportBuilder, // viewport æ„é€ æ–¹æ³•
    this.incrementCalculator, // æ»šåŠ¨å¢é‡è®¡ç®—å™¨
    this.excludeFromSemantics = false, // è¯­ä¹‰è¾…åŠ©åŠŸèƒ½ï¼ˆæ¯”å¦‚å±å¹•é˜…è¯»å™¨ï¼‰
    this.semanticChildCount, // å‘Šè¯‰è¾…åŠ©åŠŸèƒ½æ€»å…±æœ‰å¤šå°‘ä¸ªå­é¡¹
    this.dragStartBehavior = DragStartBehavior.start, // è¯†åˆ«æ»šåŠ¨æ“ä½œå¼€å§‹çš„ä¾æ®
    this.restorationId, // ç”±å¤–éƒ¨ä¼ å…¥ï¼Œå¯ç”¨äºæ”¯æŒé‡å»ºappæ—¶æ¢å¤æ»šåŠ¨ä½ç½®
    this.scrollBehavior,
    this.clipBehavior = Clip.hardEdge,
    this.hitTestBehavior = HitTestBehavior.opaque, // é»˜è®¤è®¾ç½®ä¸ºäº‹ä»¶ä¸ä¼šç©¿é€åˆ°ä¸‹å±‚
  })

  // ...
}
```

* `physics`ï¼šç»„ä»¶æ»šåŠ¨æ—¶çš„ç‰©ç†æ•ˆæœï¼Œé»˜è®¤ä½¿ç”¨`ScrollConfiguration.of(context)`
* `incrementCalculator`ï¼šç”¨äºè®¡ç®—é”®ç›˜æ–¹å‘é”®ã€é¼ æ ‡æ»šè½®çš„æ»šåŠ¨å¢é‡
* `dragStartBehavior`ï¼š`start`è¡¨ç¤ºæ‰‹æŒ‡æŒ‰ä¸‹å¹¶æ»‘åŠ¨å¾ˆå°çš„è·ç¦»æ‰è®¤ä¸ºæ»‘åŠ¨å¼€å§‹ï¼Œ`down`å°±æ˜¯æŒ‰ä¸‹å°±è®¤ä¸ºæ»‘åŠ¨å¼€å§‹
* `restorationId`ï¼š`RestorationManager`è·å–è®¾ç½®äº†`restorationId`ï¼ˆRestorationMixinï¼‰çš„æ§ä»¶æä¾›çš„æ•°æ®ï¼Œç”¨äºé‡å»ºæ—¶æ»šåŠ¨åˆ°ä¹‹å‰çš„ä½ç½®
* `scrollBehavior`ï¼šæ§åˆ¶æ»šåŠ¨æ¡ã€æ˜¯å¦æ”¯æŒå¤šç‚¹è§¦æ§ç­‰æ•ˆæœï¼Œå¹¶ä¸”ä¹Ÿæä¾›äº†`physics`é…ç½®ï¼Œä½†`physics`å‚æ•°çš„ä¼˜å…ˆçº§æ›´é«˜
* `clipBehavior`ï¼šç®¡ç†å¦‚ä½•è£å‰ªè¶…å‡ºè¾¹ç•Œçš„å†…å®¹ï¼Œ`hardEdge`å°±æ˜¯ç®€å•é«˜æ•ˆçš„ç›´æ¥è£å‰ªï¼Œæ²¡æœ‰æŠ—é”¯é½¿ï¼Œæ¯”å¦‚è¿˜æœ‰`antiAlias`æ˜¯æŠ—é”¯é½¿è£å‰ª

### ScrollableState
`Scrollable`æ˜¯`StatefulWidget`ï¼Œæ‰€ä»¥å®ƒçš„æ ¸å¿ƒä»£ç åœ¨`ScrollableState`ä¸­ï¼š
```dart
class ScrollableState extends State<Scrollable>
    with TickerProviderStateMixin, RestorationMixin
    implements ScrollContext {

  // ç®¡ç† viewport çš„æ»šåŠ¨ä½ç½®
  ScrollPosition get position => _position!;
  ScrollPosition? _position;

  // æ»šåŠ¨ç›¸å…³çš„ç‰©ç†è¡Œä¸º
  ScrollPhysics? get resolvedPhysics => _physics;
  ScrollPhysics? _physics;
  late ScrollBehavior _configuration;

  // ScrollController
  ScrollController get _effectiveScrollController =>
      widget.controller ?? _fallbackScrollController!;

  // ...

  void initState() {
    // æ²¡æœ‰è®¾ç½® controller æ—¶ï¼Œæ„é€ ä¸€ä¸ªé»˜è®¤çš„ ScrollController
  }

  
  void didChangeDependencies() {
    // ...
    _updatePosition() // æ ¸å¿ƒå°±æ˜¯è·å– scrollBehavior å’Œ physicsï¼Œå¹¶é€šè¿‡ ScrollController æ„é€ ä¸€ä¸ªå…³è”çš„ ScrollPosition
  }

  Widget build(BuildContext context) {
    Widget result = _ScrollableScope( // æ˜¯ InheritedWidgetï¼Œå­˜å‚¨ ScrollableState å’Œ ScrollPositionï¼Œä¾¿äºå­çº§è·å–
      scrollable: this,
      position: position,
      child: Listener( // ç›‘å¬é¼ æ ‡æ»šè½®äº‹ä»¶
        onPointerSignal: _receivedPointerSignal,
        child: RawGestureDetector( // ç›‘å¬æ‰‹æŒ‡è§¦æ‘¸äº‹ä»¶
          key: _gestureDetectorKey,
          gestures: _gestureRecognizers,
          behavior: widget.hitTestBehavior,
          excludeFromSemantics: widget.excludeFromSemantics,
          child: Semantics(
            explicitChildNodes: !widget.excludeFromSemantics,
            child: IgnorePointer( // æ§åˆ¶æœ‰äº›æƒ…å†µæ˜¯å¦å¿½ç•¥äº‹ä»¶
              key: _ignorePointerKey,
              ignoring: _shouldIgnorePointer,
              // æ„é€  viewportï¼ŒæŠŠ ScrollPosition ä¼ ç»™äº† viewport
              child: widget.viewportBuilder(context, position),
            ),
          ),
        ),
      ),
    );

    result = _buildChrome(context, result); // çœ‹æºç ï¼Œæ¡Œé¢ç«¯ä¼šæ·»åŠ æ»šåŠ¨æ¡

    return result;
  }

}
```
`_updatePosition()`æ–¹æ³•ä¸­ä¼šè°ƒç”¨`ScrollController`çš„`attach`æ–¹æ³•ï¼Œè®©å®ƒå’Œ`ScrollPosition`å…³è”ä¸Šï¼Œ`ScrollController`æ ¸å¿ƒå°±æ˜¯ä¸€ä¸ªæŒæœ‰`ScrollPosition`çš„`ChangeNotifier`ã€‚

#### ScrollPosition
```dart
// ViewportOffset ç»§æ‰¿è‡ª ChangeNotifier
abstract class ScrollPosition extends ViewportOffset with ScrollMetrics {
  ScrollPosition({
    required this.physics, // ä» Scrollable å¾—åˆ°çš„ physics
    required this.context, // å³ ScrollableState å¯¹è±¡ï¼Œå¯ä»¥è·å–å„ç§å’Œæ»‘åŠ¨ç›¸å…³çš„ä¿¡æ¯
    this.keepScrollOffset = true, // ç”¨äºåœ¨ Widget é‡å»ºæ—¶è¿ç§»çŠ¶æ€
    ScrollPosition? oldPosition, // ç”¨äºåœ¨ Widget é‡å»ºæ—¶è¿ç§»çŠ¶æ€
    this.debugLabel,
  })

  // æ ¸å¿ƒæ•°æ®ï¼šæ»šåŠ¨åç§»é‡
  double get pixels;
  // æ»šåŠ¨èŒƒå›´ï¼ˆviewport performLayoutæ—¶ä¼šè®¾ç½®ï¼‰
  double get minScrollExtent;
  double get maxScrollExtent;
  // viewportåœ¨æ»šåŠ¨æ–¹å‘çš„å°ºå¯¸ï¼ˆviewport performLayoutæ—¶ä¼šè®¾ç½®ï¼‰
  double get viewportDimension;

  // æ»šåŠ¨è½´ï¼Œæ¨ªå‘æˆ–è€…çºµå‘
  Axis get axis => axisDirectionToAxis(axisDirection);
  // æ˜¯å¦è¶…å‡ºæœ€å°å’Œæœ€å¤§èŒƒå›´
  bool get outOfRange => pixels < minScrollExtent || pixels > maxScrollExtent;
  // æ˜¯å¦åˆšå¥½åœ¨è¾¹ç•Œä¸Š
  bool get atEdge => pixels == minScrollExtent || pixels == maxScrollExtent;

  // å½“å‰å¯è§åŒºåŸŸï¼ˆviewportï¼‰ä¹‹å‰çš„é•¿åº¦
  double get extentBefore => math.max(pixels - minScrollExtent, 0.0);
  // å½“å‰å¯è§åŒºåŸŸï¼ˆviewportï¼‰ä¹‹åçš„é•¿åº¦
  double get extentAfter => math.max(maxScrollExtent - pixels, 0.0);
  // viewport å†…çš„é•¿åº¦ï¼Œå°äºç­‰äº viewportDimensionã€‚æ¯”å¦‚ minScrollExtent ä¸º 10ï¼Œ
  // é‚£ä¹ˆ extentInside å°±æ˜¯ viewportDimension - 10
  double get extentInside

  // æ»šåŠ¨çŠ¶æ€æœº
  ScrollActivity? get activity => _activity;
}
```
`ScrollActivity`åŒ…å«é›†ä¸­çŠ¶æ€ï¼š
* `IdleScrollActivity`ï¼šé™æ­¢çŠ¶æ€
* `HoldScrollActivity`ï¼šæŒ‰ä¸‹ä½†è¿˜æ²¡æœ‰å¼€å§‹æ‹–åŠ¨çš„çŠ¶æ€
* `DragScrollActivity`ï¼šæ‹–åŠ¨çŠ¶æ€
* `DrivenScrollActivity`ï¼šè°ƒç”¨`animateTo`æ—¶çš„åŠ¨ç”»æ»šåŠ¨çŠ¶æ€
* `BallisticScrollActivity`ï¼šæƒ¯æ€§æ»‘åŠ¨çŠ¶æ€ï¼Œ`ScrollDragController` end æ—¶è®¾ç½®

### æ»‘åŠ¨æµç¨‹
```
æ‰‹æŒ‡æŒ‰ä¸‹
    â†“
ScrollableState._handleDragDown
    â†“
è°ƒç”¨ ScrollPosition.hold è®¾ç½®çŠ¶æ€ä¸º HoldScrollActivityï¼Œåœæ­¢å¯èƒ½åœ¨æ‰§è¡Œçš„æ»šåŠ¨
    â†“
æ‰‹æŒ‡å¼€å§‹æ‹–åŠ¨
    â†“
ScrollableState._handleDragStart
    â†“
è°ƒç”¨ ScrollPosition.dragï¼Œæ„é€  ScrollDragControllerï¼Œè®¾ç½®çŠ¶æ€ä¸º DragScrollActivity
    â†“
æ‰‹æŒ‡æŒç»­æ‹–åŠ¨
    â†“
ScrollableState._handleDragUpdate
    â†“
è°ƒç”¨ ScrollDragController çš„ update æ–¹æ³•
    â†“
è°ƒç”¨ ScrollPosition å®ç°ç±» ScrollPositionWithSingleContext çš„ applyUserOffset æ–¹æ³•
    â†“
è°ƒç”¨ ScrollPosition çš„ setPixels æ–¹æ³•ï¼Œæ›´æ–° _pixelsï¼Œå‘é€ ScrollUpdateNotification é€šçŸ¥
    â†“
åˆ·æ–°UI


æ¾å¼€æ‰‹æŒ‡
    â†“
ScrollableState._handleDragEnd
    â†“
è°ƒç”¨ ScrollDragController çš„ end æ–¹æ³•
    â†“
è°ƒç”¨ ScrollPositionWithSingleContext çš„ goBallistic æ–¹æ³•
    â†“
é€Ÿåº¦è¶³å¤Ÿåˆ™è¿›å…¥ BallisticScrollActivity çŠ¶æ€ï¼Œä¼šä½¿ç”¨ AnimationController æ‰§è¡Œæ»‘åŠ¨åŠ¨ç”»ï¼Œæ¯å¸§è°ƒç”¨ ScrollPosition setPixels
é€Ÿåº¦ä¸å¤Ÿåˆ™è¿›å…¥ IdleScrollActivity çŠ¶æ€
```

### iOS å›å¼¹æ•ˆæœ
1. è§¦å‘æƒ¯æ€§æ»‘åŠ¨
åœ¨ç”¨æˆ·ç»“æŸæ‹–åŠ¨ï¼ˆæ‰‹æŒ‡ç¦»å¼€å±å¹•ï¼‰æ—¶ï¼Œ`ScrollPositionWithSingleContext` ä¼šè°ƒç”¨ `goBallistic(double velocity)` æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ¥æ”¶ç”¨æˆ·æ‹–åŠ¨äº§ç”Ÿçš„åˆå§‹é€Ÿåº¦ï¼Œå¹¶é€šè¿‡ `ScrollPhysics` åˆ›å»º `Simulation`ï¼š
```dart
// Ballistic æ˜¯æŠ•æ·çš„æ„æ€
  @override
  void goBallistic(double velocity) {
    final Simulation? simulation = physics.createBallisticSimulation(this, velocity);
    if (simulation != null) {
      beginActivity(BallisticScrollActivity(
        this,
        simulation,
        context.vsync,
        activity?.shouldIgnorePointer ?? true,
      ));
    } else {
      goIdle();
    }
  }
```

2. BouncingScrollSimulation è®¡ç®—å€¼
`BallisticScrollActivity`å†…éƒ¨ä½¿ç”¨`AnimationController`æ‰§è¡ŒåŠ¨ç”»çš„æ—¶å€™ï¼Œæ¯ä¸€å¸§è°ƒç”¨`_tick`æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨`BouncingScrollSimulation.x(time)`æ¥è®¡ç®—å½“å‰å€¼ã€‚

3. æ›´æ–°æ»šåŠ¨ä½ç½®
`BallisticScrollActivity`ç»™`AnimationController`è®¾ç½®äº†listenerï¼Œæ¯ä¸€å¸§æ‰§è¡Œ`_tick`å°±ä¼šä»`AnimationController`å¾—åˆ°å½“å‰å€¼ï¼Œè°ƒç”¨`ScrollPositionWithSingleContext.setPixels`æ›´æ–°æ»šåŠ¨ä½ç½®ã€‚


#### æ‹–åŠ¨æ—¶çš„é˜»å°¼æ•ˆæœ
å‰é¢ä»‹ç»æ»‘åŠ¨æµç¨‹æ—¶ï¼ŒçŸ¥é“æ‹–åŠ¨æ—¶ä¼šè°ƒç”¨ `ScrollPositionWithSingleContext` çš„ `applyUserOffset` æ–¹æ³•ï¼š
```dart
@override
void applyUserOffset(double delta) {
  updateUserScrollDirection(delta > 0.0 ? ScrollDirection.forward : ScrollDirection.reverse);
  // æœ€ç»ˆçš„ä½ç½®ï¼Œä¼šé€šè¿‡ BouncingScrollPhysics æ¥è®¡ç®—
  setPixels(pixels - physics.applyPhysicsToUserOffset(this, delta));
}
```
`BouncingScrollPhysics`çš„`applyPhysicsToUserOffset`è®¡ç®—å®ç°å°±ä¼šè€ƒè™‘é˜»å°¼æ•ˆæœã€‚

#### ç»„åˆå¤šç§ ScrollPhysics
`ScrollPhysics.applyTo`æ–¹æ³•å¯ä»¥ç”¨äºç»„åˆå¤šç§`ScrollPhysics`ï¼Œæ¯”å¦‚ï¼š
```dart
// ç»„åˆ AlwaysScrollableScrollPhysics å’Œ BouncingScrollPhysics
final physics = const BouncingScrollPhysics().applyTo(const AlwaysScrollableScrollPhysics());

// AlwaysScrollableScrollPhysicsï¼šå³ä½¿å†…å®¹ä¸è¶³ä¸€å±ä¹Ÿå…è®¸æ»šåŠ¨ã€‚
// BouncingScrollPhysicsï¼šæ»šåŠ¨åˆ°è¾¹ç•Œæ—¶äº§ç”Ÿå¼¹æ€§å›å¼¹æ•ˆæœã€‚
```

## Sliver å’Œ SliverConstraint
`SliverConstraint`æ˜¯`Viewport`ä¼ ç»™`RenderSliver`çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹`SliverConstraint`æä¾›äº†å“ªäº›ä¿¡æ¯ã€‚

**åæ ‡ç›¸å…³ï¼š**
* `axisDirection`ï¼šæ»šåŠ¨çš„ä¸»è½´æ–¹å‘ï¼Œä¸Šã€ä¸‹ã€å·¦ã€å³
* `crossAxisDirection`ï¼šäº¤å‰è½´çš„æ–¹å‘
* `crossAxisExtent`ï¼šäº¤å‰è½´çš„èŒƒå›´ï¼Œä¾‹å¦‚å‚ç›´æƒ…å†µï¼Œè¿™å°±æ˜¯sliverçš„å®½åº¦
* `growthDirection`ï¼šsliverçš„æ’åˆ—æ–¹å‘ï¼Œå¦‚æœæ˜¯`forward`å°±å’Œ`axisDirection`ä¸€æ ·ï¼Œå¦‚æœæ˜¯`reverse`åˆ™ç›¸å
* `userScrollDirection`ï¼šç”¨æˆ·çš„æ»‘åŠ¨æ–¹å‘ï¼ˆä¾‹å¦‚å¯æŠ˜å çš„headerä¼šæ ¹æ®è¿™ä¸ªå˜åŒ–ï¼‰ï¼Œå½“ç”¨æˆ·ä¸è§¦æ‘¸å±å¹•æ—¶ï¼Œå®ƒå°±æ˜¯ ScrollDirection.idleã€‚å½“ç”¨æˆ·è§¦æ‘¸å±å¹•ä½†æ‰‹æŒ‡ä¸åŠ¨æ—¶ï¼Œå±å¹•ä¹Ÿä¼šæ˜¾ç¤ºä¸º ScrollDirection.idleã€‚å½“ç”¨æˆ·å¼€å§‹æ»šåŠ¨æ—¶ï¼ŒuserScrollDirection å¯ä»¥æ˜¯ ScrollDirection.forward æˆ– ScrollDirection.reverseã€‚è¿™å–å†³äºç”¨æˆ·ç§»åŠ¨çš„æ–¹å‘ã€‚

**æ»šåŠ¨ç›¸å…³ï¼š**
* `scrollOffset`ï¼šsliverçš„æ»‘åŠ¨åç§»é‡ï¼Œä¾‹å¦‚axisDirectionä¸ºä¸‹ï¼ŒgrowthDirectionä¸ºæ­£ï¼Œé‚£ä¹ˆåç§»é‡å°±æ˜¯ç¬¬ä¸€ä¸ªsliverçš„é¡¶éƒ¨è·ç¦»viewporté¡¶éƒ¨çš„è·ç¦»
* `precedingScrollExtent`ï¼šè¡¨ç¤ºå½“å‰ Sliver ä¹‹å‰æ‰€æœ‰ Sliver å·²å ç”¨çš„æ»šåŠ¨è·ç¦»æ€»å’Œã€‚
  1. ç´¯è®¡æ»šåŠ¨è·ç¦»ï¼šè¡¨ç¤ºå½“å‰ Sliver ä¹‹å‰æ‰€æœ‰ Sliver å ç”¨çš„æ€»æ»šåŠ¨ç©ºé—´ã€‚ 
  2. æ‡’åŠ è½½åœºæ™¯ï¼šå¦‚æœå‰é¢çš„ Sliverï¼ˆå¦‚ SliverListï¼‰æ˜¯æ‡’åŠ è½½çš„ï¼Œä¸”æ— æ³•é¢„ä¼°æ€»é•¿åº¦ï¼ŒprecedingScrollExtent ä¼šæš‚æ—¶ä¸º double.infinityï¼Œç›´åˆ°èƒ½è®¡ç®—å‡ºå‡†ç¡®é•¿åº¦ã€‚
  3. æ— é™æ»šåŠ¨åœºæ™¯ï¼šå¦‚æœå‰é¢çš„ Sliver æ˜¯æ— é™é•¿çš„ï¼ˆå¦‚æ— é™åˆ—è¡¨ï¼‰ï¼Œåç»­æ‰€æœ‰ Sliver çš„ precedingScrollExtent éƒ½ä¼šæ˜¯ double.infinityã€‚
* `remainingPaintExtent`ï¼šViewportå‰©ä½™çš„å¯ç»˜åˆ¶èŒƒå›´ï¼ŒSliverå¯ä»¥æ ¹æ®å®ƒç¡®å®šç»˜åˆ¶å¤šå°‘å†…å®¹
* `overlap`ï¼šè¡¨ç¤ºå½“å‰ sliver åœ¨ä¸»è½´æ–¹å‘ä¸Šï¼Œéœ€è¦é¿è®©çš„ã€å·²è¢«å‰ä¸€ä¸ª sliver ç»˜åˆ¶çš„åŒºåŸŸåƒç´ æ•°ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå‘Šè¯‰å½“å‰ sliverï¼šâ€œå‰ä¸€ä¸ª sliver å·²ç»åœ¨ä½ çš„ç»˜åˆ¶èŒƒå›´å†…å äº†è¿™ä¹ˆå¤šåƒç´ ï¼Œä½ éœ€è¦ä»è¿™ä¸ªä½ç½®ä¹‹åå¼€å§‹ç»˜åˆ¶ï¼Œé¿å…é‡å æˆ–è¦†ç›–â€ã€‚ä¾‹å¦‚ `SliverAppBar`ï¼Œå®ƒçš„ layoutExtent å¯èƒ½è¾ƒå°ï¼ˆä»…å æ®å¯¼èˆªæ æŠ˜å åçš„é«˜åº¦ï¼‰ï¼Œä½† paintExtent è¾ƒå¤§ï¼ˆéœ€è¦ç»˜åˆ¶å±•å¼€åçš„å®Œæ•´é«˜åº¦ï¼Œè¦†ç›–éƒ¨åˆ†å±å¹•ï¼‰ï¼Œoverlap ä¼šå‘ŠçŸ¥ä¸‹æ–¹çš„åˆ—è¡¨ sliverï¼ˆå¦‚ SliverListï¼‰éœ€è¦ä»å¯¼èˆªæ ä¸‹æ–¹å¼€å§‹ç»˜åˆ¶ï¼Œé¿å…å†…å®¹è¢«å¯¼èˆªæ é®æŒ¡ã€‚
* `viewportMainAxisExtent`ï¼šviewportçš„ä¸»è½´èŒƒå›´ï¼Œä¾‹å¦‚å‚ç›´æƒ…å†µï¼Œå°±æ˜¯viewportçš„é«˜åº¦
* `cacheOrigin`ï¼šæè¿°å½“å‰å®é™…ç¼“å­˜åŒºåŸŸç›¸å¯¹äºå½“å‰æ»šåŠ¨åç§»é‡ï¼ˆ`scrollOffset`ï¼‰çš„èµ·å§‹ä½ç½®ï¼Œç¡®ä¿åœ¨ç”¨æˆ·æ»šåŠ¨æ—¶å†…å®¹èƒ½å¿«é€Ÿæ˜¾ç¤ºï¼Œå‡å°‘å¡é¡¿ã€‚å€¼å§‹ç»ˆä¸º0æˆ–è´Ÿæ•°ï¼Œä¸”ä¸ä¼šå°äº -scrollOffsetï¼Œç¡®ä¿ Sliver ä¸ä¼šè¢«è¦æ±‚æ¸²æŸ“å…¶é›¶æ»šåŠ¨åç§»é‡ä¹‹å‰çš„å†…å®¹ã€‚æ¯”å¦‚ä¸º -100.0ï¼Œåˆ™è¡¨ç¤º Sliver åº”ä» scrollOffset å¾€å‰ 100 åƒç´ å¤„å¼€å§‹æ¸²æŸ“å†…å®¹ï¼Œä»¥å¡«å……ç¼“å­˜åŒºåŸŸã€‚
* `remainingCacheExtent`ï¼šè¡¨ç¤ºSliveréœ€è¦æä¾›çš„ç¼“å­˜å†…å®¹çš„æ€»é•¿åº¦ï¼Œä»cacheOriginå¼€å§‹è®¡ç®—ã€‚é€šå¸¸å¤§äºç­‰äº`remainingPaintExtent`ï¼ˆå¯è§åŒºåŸŸé•¿åº¦ï¼‰ï¼Œå› ä¸ºç¼“å­˜åŒºåŸŸåŒ…å«å¯è§åŒºåŸŸå’Œé¢å¤–çš„é¢„æ¸²æŸ“åŒºåŸŸã€‚


> ä¸ºä»€ä¹ˆè¦ä½¿ç”¨overlapï¼Œä¸ç›´æ¥ä¿®æ”¹ AppBar é«˜åº¦æ¥å®ç°å¯æŠ˜å çš„headerï¼Ÿé€šè¿‡é«˜åº¦å®ç°ä¼šå¯¼è‡´ header ä¸‹æ–¹çš„ SliverList é‡æ–°å¸ƒå±€ï¼Œè€Œé€šè¿‡ overlap å¯ä»¥åªç»˜åˆ¶åç§»ï¼›å¹¶ä¸”å‡è®¾ AppBar æ˜¯åŠé€æ˜çš„ï¼ˆå¦‚ iOS é£æ ¼ï¼‰ï¼Œåˆ—è¡¨å†…å®¹æ»šåŠ¨åˆ° AppBar åŒºåŸŸæ—¶ï¼Œèƒ½æ˜¾ç¤ºåœ¨å…¶ä¸‹æ–¹ï¼ˆè§†è§‰ä¸Šè¢«æ¯›ç»ç’ƒè¦†ç›–ï¼‰ï¼›


### è¾“å‡º SliverGeometry
`SliverConstraint`æ˜¯`RenderViewport`ä¼ ç»™å­çº§ Sliver çš„å¸ƒå±€çº¦æŸï¼Œè€Œ Sliver é€šè¿‡å®ƒå¾—åˆ° `SliverGeometry`ï¼Œè¿™æ˜¯è¿”å›ç»™`RenderViewport`çš„å¸ƒå±€ç»“æœã€‚

* `double scrollExtent`ï¼šSliver çš„æ€»å…±å¯ä»¥æ»šåŠ¨çš„è·ç¦»
* `double paintExtent`ï¼šå½“å‰æ»šåŠ¨ä½ç½®ä¸‹å®é™…çš„å¯è§åŒºåŸŸå¤§å°
* `double layoutExtent`ï¼šè¡¨ç¤ºä»å½“å‰ sliver çš„å¯è§éƒ¨åˆ†åˆ°ä¸‹ä¸€ä¸ª sliver å¯è§éƒ¨åˆ†çš„è·ç¦»ï¼Œå¿…é¡»ä»‹äº 0 å’Œ paintExtent ä¹‹é—´ï¼Œé»˜è®¤å€¼ç­‰äº paintExtentã€‚æ¯”å¦‚ä¸€ä¸ª sliver çš„ paintExtent ä¸º 100ï¼ˆè§†è§‰ä¸Šç»˜åˆ¶ 100 åƒç´ ï¼‰ï¼Œä½† layoutExtent è®¾ä¸º 50ï¼Œåˆ™ä¸‹ä¸€ä¸ª sliver ä¼šä»å½“å‰ sliver å¸ƒå±€ä½ç½®çš„ 50 åƒç´ å¤„å¼€å§‹å¸ƒå±€ï¼Œå®ç°è§†è§‰ä¸Šçš„é‡å æ•ˆæœï¼ˆå¦‚æ‚¬æµ®ç»„ä»¶ï¼‰ã€‚
* `double maxPaintExtent`ï¼šè¡¨ç¤º sliver åœ¨æ— é™ç©ºé—´ä¸‹çš„æœ€å¤§å¯ç»˜åˆ¶èŒƒå›´ï¼Œç”¨äºæ”¯æŒâ€œæ”¶ç¼©åŒ…è£¹â€ï¼ˆshrink-wrappingï¼‰çš„è§†å£è®¡ç®—æ€»å°ºå¯¸ã€‚å¯¹äºåŠ¨æ€å†…å®¹åˆ—è¡¨ï¼ˆå¦‚ SliverListï¼‰ï¼ŒmaxPaintExtent é€šå¸¸ç­‰äºæ‰€æœ‰å­é¡¹çš„æ€»é«˜åº¦ï¼Œå¸®åŠ©è§†å£ï¼ˆå¦‚ RenderShrinkWrappingViewportï¼‰è®¡ç®—è‡ªèº«éœ€è¦æ”¶ç¼©åŒ…è£¹çš„æ€»å°ºå¯¸ã€‚
* `double maxScrollObstructionExtent`ï¼šè‹¥ sliver ä¸ä¼šå›ºå®šåœ¨è¾¹ç¼˜ï¼ˆå¦‚æ™®é€šåˆ—è¡¨é¡¹ï¼‰ï¼Œæ­¤å€¼ä¸º 0ï¼›è‹¥ä¼šå›ºå®šï¼ˆå¦‚æ‚¬æµ®å¯¼èˆªæ ï¼‰ï¼Œåˆ™ä¸ºå…¶å›ºå®šæ—¶çš„å°ºå¯¸ã€‚ä¾‹å¦‚ SliverAppBar å›ºå®šåœ¨é¡¶éƒ¨æ—¶ï¼ŒmaxScrollObstructionExtent ç­‰äºå…¶é«˜åº¦ï¼ˆå¦‚ 56 åƒç´ ï¼‰ï¼Œæ­¤æ—¶è§†å£çš„å¯æ»šåŠ¨åŒºåŸŸä¼šå‡å°‘ 56 åƒç´ ï¼Œç¡®ä¿å†…å®¹ä¸ä¼šè¢«å¯¼èˆªæ é®æŒ¡ã€‚
* `double crossAxisExtent`ï¼šäº¤å‰è½´æ–¹å‘ä¸Šçš„å°ºå¯¸ï¼ˆå¦‚å‚ç›´æ»šåŠ¨åˆ—è¡¨ä¸­çš„å®½åº¦ï¼‰ã€‚å¤§å¤šæ•° sliver ä¼šå æ»¡äº¤å‰è½´æ–¹å‘çš„å¯ç”¨ç©ºé—´ï¼ˆæ­¤æ—¶ crossAxisExtent ä¸º nullï¼‰ï¼Œä½†éƒ¨åˆ†ç‰¹æ®Š sliverï¼ˆå¦‚ SliverConstrainedCrossAxisï¼‰å¯èƒ½éœ€è¦è‡ªå®šä¹‰äº¤å‰è½´å°ºå¯¸ï¼Œæ­¤æ—¶éœ€æ˜¾å¼è®¾ç½®è¯¥å€¼ã€‚
* `double paintOrigin`ï¼šsliver ç¬¬ä¸€ä¸ªå¯è§éƒ¨åˆ†åœ¨å…¶å¸ƒå±€åæ ‡ç³»ä¸­çš„èµ·å§‹åç§»é‡ï¼ˆç›¸å¯¹äºè‡ªèº«å¸ƒå±€ä½ç½®çš„åç§»ï¼‰ã€‚é»˜è®¤ä¸º0ï¼Œè‹¥ paintOrigin = -50ï¼Œåˆ™ sliver ä¼šä»å¸ƒå±€ä½ç½®ä¸Šæ–¹ 50 åƒç´ å¤„å¼€å§‹ç»˜åˆ¶å†…å®¹ï¼ˆå¯èƒ½ç”¨äºå®ç°è§†è§‰åç§»æ•ˆæœï¼‰
* `double hitTestExtent`ï¼šsliver å“åº”è§¦æ‘¸äº‹ä»¶çš„èŒƒå›´ï¼Œé»˜è®¤ç­‰äº paintExtent
* `double cacheExtent`ï¼šè¡¨ç¤º Sliver åœ¨ç¼“å­˜åŒºä¸­æ¶ˆè€—çš„ç©ºé—´ï¼Œç­‰äº Sliver åœ¨è§†å£ç¼“å­˜åŒºåŸŸä¸­å®é™…æ¸²æŸ“çš„åƒç´ é•¿åº¦ã€‚å®ƒæè¿°äº†ï¼šä»ç¼“å­˜åŒºåŸŸçš„èµ·å§‹ä½ç½®ï¼ˆç”± SliverConstraints.cacheOrigin å®šä¹‰ï¼‰å¼€å§‹ï¼ŒSliver éœ€è¦æä¾›å¤šå°‘åƒç´ çš„å†…å®¹æ¥å¡«å……ç¼“å­˜åŒºã€‚
* `bool visible`ï¼šæ ‡è®° sliver æ˜¯å¦éœ€è¦è¢«ç»˜åˆ¶ã€‚é»˜è®¤paintExtent > 0ï¼ˆå³ç»˜åˆ¶èŒƒå›´å¤§äº 0 ï¼‰æ—¶å¯è§
* `bool hasVisualOverflow`ï¼šæ ‡è®° sliver å†…å®¹æ˜¯å¦è¶…å‡ºå…¶ç»˜åˆ¶èŒƒå›´ï¼ˆå³æ˜¯å¦å­˜åœ¨è§†è§‰æº¢å‡ºï¼‰ã€‚è‹¥ä¸º trueï¼Œè§†å£ä¼šå¯¹ sliver å†…å®¹è¿›è¡Œè£å‰ªï¼ˆé¿å…æº¢å‡ºå†…å®¹æ˜¾ç¤ºåœ¨è§†å£å¤–ï¼‰
* `double? scrollOffsetCorrection`ï¼šå½“ sliver å¸ƒå±€å®Œæˆåï¼Œè‹¥è¯¥å€¼é nullï¼Œçˆ¶å®¹å™¨ä¼šæ ¹æ®æ­¤å€¼è°ƒæ•´æ»šåŠ¨åç§»é‡ï¼Œå¹¶é‡æ–°è§¦å‘å¸ƒå±€ã€‚ç”¨äºåŠ¨æ€ä¿®æ­£æ»šåŠ¨ä½ç½®ã€‚ä¾‹å¦‚ï¼Œå½“ sliver éœ€è¦å°†æŸä¸ªå­é¡¹å±…ä¸­æ˜¾ç¤ºæ—¶ï¼Œå¯é€šè¿‡ scrollOffsetCorrection å‘ŠçŸ¥çˆ¶å®¹å™¨è°ƒæ•´æ»šåŠ¨åç§»ï¼Œä½¿ç›®æ ‡å­é¡¹å±…ä¸­ã€‚


### å¤„ç†æµç¨‹
1. `RenderViewport`è°ƒç”¨`performLayout`æ–¹æ³• --> `_attemptLayout` æ–¹æ³•
2. è°ƒç”¨`layoutChildSequence`æ–¹æ³•
3. ä¸ºæ¯ä¸ªå­çº§`RenderSliver`è°ƒç”¨`layout`æ–¹æ³•ï¼Œä¼ å…¥`SliverConstraints`
4. `RenderSliver`çš„`performLayout`æ–¹æ³•æ ¹æ®`SliverConstraints`ï¼Œè®¡ç®—ç”Ÿæˆ`SliverGeometry`

## ViewPort
`Viewport`ç»§æ‰¿è‡ª`MultiChildRenderObjectWidget`ï¼Œä¸»è¦è´Ÿè´£ä»¥ä¸‹å·¥ä½œï¼š
* å¤„ç†æ»šåŠ¨ï¼šç›‘å¬`ViewportOffset`ï¼ˆScrollPositionçš„çˆ¶ç±»ï¼‰çš„æ»šåŠ¨ä½ç½®å˜åŒ–ï¼Œè°ƒæ•´å¯è§èŒƒå›´å†…çš„Sliveræ¸²æŸ“
* æ‰§è¡Œå¸ƒå±€ï¼šå‘Sliverå­ç»„ä»¶ä¼ é€’`SliverConstraint`çº¦æŸä¿¡æ¯ï¼Œä½¿Sliverå¯ä»¥æ°å½“çš„ç¡®è®¤æ¸²æŸ“å†…å®¹

`Viewport`æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š
```dart
class Viewport extends MultiChildRenderObjectWidget {
  Viewport({
    super.key,
    this.axisDirection = AxisDirection.down, // ä¸»è½´æ»šåŠ¨æ–¹å‘
    this.crossAxisDirection, // äº¤å‰è½´æ–¹å‘
    this.anchor = 0.0, // ä½œç”¨æ˜¯å®šä¹‰è§†å£ï¼ˆViewportï¼‰ä¸­é›¶æ»šåŠ¨åç§»é‡ï¼ˆzero scroll offsetï¼‰çš„ç›¸å¯¹ä½ç½®ã€‚
    required this.offset, // ViewportOffset å†³å®šæ»šåŠ¨ä½ç½®
    this.center,
    this.cacheExtent,
    this.cacheExtentStyle = CacheExtentStyle.pixel,
    this.clipBehavior = Clip.hardEdge,
    List<Widget> slivers = const <Widget>[],
  })
```
* `anchor`ï¼šå…·ä½“æ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªå–å€¼èŒƒå›´ä¸º 0.0 åˆ° 1.0 çš„ç›¸å¯¹å€¼ï¼Œç”¨äºç¡®å®šå½“æ»šåŠ¨åç§»é‡ä¸º 0 æ—¶ï¼Œå†…å®¹åœ¨è§†å£ä¸»è½´æ–¹å‘ä¸Šçš„å¯¹é½ä½ç½®ã€‚ä¾‹å¦‚å‡è®¾ axisDirection ä¸ºå‚ç›´æ–¹å‘ï¼ˆAxisDirection.down æˆ–è€… AxisDirection.upï¼‰ï¼Œä¸” anchor ä¸º 0.5ï¼Œåˆ™é›¶æ»šåŠ¨åç§»é‡ä¼šå‚ç›´å±…ä¸­äºè§†å£ï¼›
* `center`ï¼š`center` æ˜¯ä¸€ä¸ª `Key?` ç±»å‹çš„å±æ€§ï¼Œç”¨äºæŒ‡å®šè§†å£ï¼ˆViewportï¼‰ä¸­ä½œä¸ºâ€œä¸­å¿ƒé”šç‚¹â€çš„å­ç»„ä»¶ã€‚å…¶æ ¸å¿ƒä½œç”¨æ˜¯ç¡®å®šè§†å£å†…å®¹çš„å¸ƒå±€èµ·ç‚¹å’Œç”Ÿé•¿æ–¹å‘ã€‚center å¯¹åº”çš„å­ç»„ä»¶ä¼šè¢«æ”¾ç½®åœ¨æ»šåŠ¨åç§»é‡ï¼ˆoffset.pixelsï¼‰ä¸º 0 çš„ä½ç½®ï¼Œæ˜¯è§†å£å†…å®¹çš„â€œåŸç‚¹â€ã€‚`center` ä¹‹åçš„å­ç»„ä»¶ä¼šæŒ‰ç…§ axisDirectionï¼ˆä¸»è½´æ–¹å‘ï¼‰ä¾æ¬¡æ’åˆ—ï¼ˆä¾‹å¦‚ AxisDirection.down æ—¶å‘ä¸‹æ’åˆ—ï¼‰ã€‚center ä¹‹å‰çš„å­ç»„ä»¶ä¼šæŒ‰ç…§ `axisDirection` çš„åæ–¹å‘æ’åˆ—ï¼ˆä¾‹å¦‚ AxisDirection.down æ—¶å‘ä¸Šæ’åˆ—ï¼‰ã€‚è‹¥æœªæ˜¾å¼æŒ‡å®š centerï¼Œåˆ™é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªå­ç»„ä»¶ä½œä¸ºä¸­å¿ƒé”šç‚¹
* `cacheExtent`ï¼šdouble? ç±»å‹çš„å±æ€§ï¼Œç”¨äºæ§åˆ¶è§†å£åœ¨å¯è§åŒºåŸŸä¹‹å¤–é¢„æ¸²æŸ“çš„å†…å®¹èŒƒå›´ï¼Œå•ä½ç”± cacheExtentStyle å†³å®šã€‚å…¶æ ¸å¿ƒä½œç”¨æ˜¯ä¼˜åŒ–æ»šåŠ¨ä½“éªŒã€‚
* `cacheExtentStyle`ï¼š`CacheExtentStyle.pixel`ï¼ˆé»˜è®¤å€¼ï¼‰ï¼šcacheExtent ä»¥é€»è¾‘åƒç´ ä¸ºå•ä½ï¼›`CacheExtentStyle.viewport`ï¼šcacheExtent ä»¥è§†å£ä¸»è½´å°ºå¯¸çš„æ¯”ä¾‹ä¸ºå•ä½ï¼ˆä¾‹å¦‚ cacheExtent: 0.5 è¡¨ç¤ºé¢„æ¸²æŸ“å¯è§åŒºåŸŸå¤– 50% è§†å£é«˜åº¦/å®½åº¦çš„å†…å®¹ï¼‰
* `slivers`ï¼šå­çº§ sliver ç»„ä»¶


`Viewport`ä¼šæ„é€ `RenderViewport`ï¼š
```dart
  @override
  RenderViewport createRenderObject(BuildContext context) {
    return RenderViewport(
      axisDirection: axisDirection,
      crossAxisDirection:
          crossAxisDirection ?? Viewport.getDefaultCrossAxisDirection(context, axisDirection),
      anchor: anchor,
      offset: offset,
      cacheExtent: cacheExtent,
      cacheExtentStyle: cacheExtentStyle,
      clipBehavior: clipBehavior,
    );
  }
```

### RenderViewport
`RenderViewport`ç»§æ‰¿`RenderViewportBase`ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª`RenderBox`ï¼Œè¯´æ˜`RenderViewport`è‡ªèº«ä½¿ç”¨`Box`å¸ƒå±€ä½“ç³»ï¼Œåªä¸è¿‡å®ƒç»™å†…éƒ¨çš„å­ç»„ä»¶ä½¿ç”¨çš„æ˜¯`Sliver`å¸ƒå±€ä½“ç³»ã€‚
```dart
class RenderViewport extends RenderViewportBase<SliverPhysicalContainerParentData>

abstract class RenderViewportBase<ParentDataClass extends ContainerParentDataMixin<RenderSliver>>
    extends RenderBox
    with ContainerRenderObjectMixin<RenderSliver, ParentDataClass>
    implements RenderAbstractViewport 
```

#### åˆå§‹åŒ–
```
attach()
    â†“
è°ƒç”¨å…¨éƒ¨å­çº§ RenderObject çš„ attach æ–¹æ³•ï¼›
_offset.addListener(markNeedsLayout) ç›‘å¬ ScrollPosition
```

#### å¸ƒå±€
```dart
//RenderViewport

void performLayout() {
  // å­˜å‚¨Viewportçš„å®½åº¦æˆ–é«˜åº¦åˆ°ScrollPositionä¸­
  switch (axis) {
    case Axis.vertical:
      offset.applyViewportDimension(size.height);
      break;
    case Axis.horizontal:
      offset.applyViewportDimension(size.width);
      break;
  }
  // Viewportå¯¹åº”çš„_ViewportElementä¸­ï¼Œå› ä¸ºListViewçš„æƒ…å†µæ²¡æœ‰è®¾ç½®centerï¼Œé‚£ä¹ˆä¼šæŠŠsliversåˆ—è¡¨çš„ç¬¬ä¸€ä¸ªä½œä¸ºRenderViewportçš„centerï¼Œè€ŒListViewçš„æƒ…å†µä¸‹ï¼Œsliversä¹Ÿä»…ä»…æœ‰ä¸€ä¸ªSliverListï¼Œ
  // æ‰€ä»¥è¿™ä¸ªcenterå°±æ˜¯SliverListæœ¬èº«
  if (center == null) { // å‡å¦‚æ²¡æœ‰å­ç»„ä»¶ï¼Œåˆ™æ»šåŠ¨èŒƒå›´ã€å†…å®¹å°ºå¯¸ä¸º0
    _minScrollExtent = 0.0;
    _maxScrollExtent = 0.0;
    _hasVisualOverflow = false;
    offset.applyContentDimensions(0.0, 0.0);
    return;
  }
  
  // ------------------------ è®¡ç®—å¸ƒå±€å‚æ•° -----------------------------

  // è®¾ç½®ä¸»è½´å’Œäº¤å‰è½´çš„èŒƒå›´ä¸ºViewportçš„å®½é«˜
  double mainAxisExtent;
  double crossAxisExtent;
  switch (axis) {
    case Axis.vertical:
      mainAxisExtent = size.height;
      crossAxisExtent = size.width;
      break;
    case Axis.horizontal:
      mainAxisExtent = size.width;
      crossAxisExtent = size.height;
      break;
  }
  // centerçš„åç§»è°ƒæ•´ï¼Œé»˜è®¤0
  final double centerOffsetAdjustment = center!.centerOffsetAdjustment;
  double correction;// éœ€è¦æ›´æ­£çš„åç§»å€¼
  int count = 0;

  // ------------------------ æ‰§è¡Œå¸ƒå±€ -----------------------------

  // å°è¯•å¸ƒå±€ï¼Œå¦‚æœä¸éœ€è¦è°ƒæ•´ï¼Œåˆ™å®Œæˆå¸ƒå±€ï¼Œå¦‚æœéœ€è¦è°ƒæ•´ï¼Œåˆ™å†æ¬¡å°è¯•å¸ƒå±€ï¼Œå°è¯•æ¬¡æ•°ä¸º10
  do {
    //æ ¹æ®ä¸»è½´å’Œäº¤å‰è½´çš„èŒƒå›´ï¼Œä»¥åŠæ»šåŠ¨é‡offset.pixelsï¼Œæ¥å°è¯•å¸ƒå±€
    correction = _attemptLayout(mainAxisExtent, crossAxisExtent, offset.pixels + centerOffsetAdjustment);
    if (correction != 0.0) {
      offset.correctBy(correction);//å¦‚æœéœ€è¦è°ƒæ•´ï¼Œåˆ™è°ƒæ•´æ»šåŠ¨é‡
    } else {
      //ä¸éœ€è¦è°ƒæ•´ï¼Œåˆ™è®¾ç½®å†…å®¹å°ºå¯¸
      if (offset.applyContentDimensions(
            math.min(0.0, _minScrollExtent + mainAxisExtent * anchor),
            math.max(0.0, _maxScrollExtent - mainAxisExtent * (1.0 - anchor)),
         ))
        break;
    }
    count += 1;
  } while (count < _maxLayoutCycles);
  ...//è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸
}
```

ç»§ç»­çœ‹`_attemptLayout`ï¼š
```dart
//RenderViewport

double _attemptLayout(double mainAxisExtent, double crossAxisExtent, double correctedOffset) {
  // ------------------------ é‡ç½®å¸ƒå±€æ•°æ® -----------------------------
  _minScrollExtent = 0.0;
  _maxScrollExtent = 0.0;
  _hasVisualOverflow = false;

  // ------------------------ è®¡ç®—centeråç§»å’Œç»˜åˆ¶èŒƒå›´ -----------------------------

  // ä¸€èˆ¬åˆå§‹ä¸º0ã€‚anchor é»˜è®¤ä¸º 0ï¼Œå¦‚æœæ‰‹æŒ‡å¾€ä¸Šæ»‘ï¼Œä¹Ÿå°±æ˜¯å†…å®¹å¾€ä¸Šç§»åŠ¨ï¼Œoffset.pixelsä¸ºæ­£å€¼ï¼Œæ‰€ä»¥centerOffsetä¼šå˜ä¸ºè´Ÿå€¼
  final double centerOffset = mainAxisExtent * anchor - correctedOffset;
  // åå‘çš„å‰©ä½™å¯ç»˜åˆ¶èŒƒå›´
  final double reverseDirectionRemainingPaintExtent = centerOffset.clamp(0.0, mainAxisExtent);
  // æ­£å‘çš„å‰©ä½™å¯ç»˜åˆ¶èŒƒå›´ï¼ŒmainAxisExtent å°±æ˜¯ viewport é«˜åº¦ï¼ŒmainAxisExtent - centerOffset ä¼šå¤§äº mainAxisExtent
  // æ‰€ä»¥ä¸€èˆ¬æƒ…å†µï¼ŒforwardDirectionRemainingPaintExtent ä»ç„¶ä¸º mainAxisExtent
  final double forwardDirectionRemainingPaintExtent = (mainAxisExtent - centerOffset).clamp(0.0, mainAxisExtent);

  // ------------------------ è®¡ç®—ç¼“å­˜èŒƒå›´ -----------------------------
  switch (cacheExtentStyle) {
    case CacheExtentStyle.pixel:
      _calculatedCacheExtent = cacheExtent; // é»˜è®¤250
      break;
    case CacheExtentStyle.viewport:
      _calculatedCacheExtent = mainAxisExtent * _cacheExtent;
      break;
  }
  //æ•´ä¸ªç¼“å­˜èŒƒå›´ï¼Œä¹Ÿå°±æ˜¯viewportçš„é«˜åº¦åŠ ä¸Šå‰åçš„ç¼“å­˜èŒƒå›´ã€‚ä¾‹å¦‚Viewporté«˜500ï¼ŒåŠ ä¸Šä¸¤ä¸ªç¼“å­˜èŒƒå›´ï¼Œå°±æ˜¯1000
  final double fullCacheExtent = mainAxisExtent + 2 * _calculatedCacheExtent!;
  final double centerCacheOffset = centerOffset + _calculatedCacheExtent!;
  //ååºç¼“å­˜èŒƒå›´ï¼Œä¾‹å¦‚åˆå§‹0ä½ç½®ï¼Œé‚£ä¹ˆååºå‰©ä½™èŒƒå›´å°±æ˜¯250ï¼›å†…å®¹å¾€ä¸Šæ»šåŠ¨ï¼ŒcenterOffsetä¸º-50ï¼Œé‚£ä¹ˆå°±æ˜¯200ï¼›æœ€å°ä¸º0
  final double reverseDirectionRemainingCacheExtent = centerCacheOffset.clamp(0.0, fullCacheExtent);
  //æ­£åºç¼“å­˜èŒƒå›´ï¼Œä¾‹å¦‚åˆå§‹0ä½ç½®ï¼Œé‚£ä¹ˆæ­£åºå‰©ä½™èŒƒå›´å°±æ˜¯750ï¼›å†…å®¹å¾€ä¸Šæ»šåŠ¨ï¼ŒcenterOffsetä¸º-50ï¼Œé‚£ä¹ˆå°±æ˜¯800ï¼›æœ€å¤§ä¸º1000
  final double forwardDirectionRemainingCacheExtent = (fullCacheExtent - centerCacheOffset).clamp(0.0, fullCacheExtent);
  final RenderSliver? leadingNegativeChild = childBefore(center!);
  // å¯¹äºListViewçš„æƒ…å†µï¼Œæ‰€æœ‰æ™®é€šæ§ä»¶éƒ½æ˜¯æ”¾åœ¨å”¯ä¸€ä¸€ä¸ªSliverListä¸­ï¼Œæ‰€ä»¥ä»…ä»…åªæœ‰centerè‡ªå·±ï¼Œæ²¡æœ‰å…„å¼ŸSliver
  if (leadingNegativeChild != null) {
    // --------------------- å¸ƒå±€centerä¹‹å‰çš„å­å…ƒç´  ----------------------
    final double result = layoutChildSequence(
      child: leadingNegativeChild,
      scrollOffset: math.max(mainAxisExtent, centerOffset) - mainAxisExtent,
      overlap: 0.0,
      layoutOffset: forwardDirectionRemainingPaintExtent,
      remainingPaintExtent: reverseDirectionRemainingPaintExtent,
      mainAxisExtent: mainAxisExtent,
      crossAxisExtent: crossAxisExtent,
      growthDirection: GrowthDirection.reverse,
      advance: childBefore, // åå‘æƒ…å†µï¼Œéå†ä¼šè°ƒç”¨ childBefore è·å–å‰ä¸€ä¸ª child
      remainingCacheExtent: reverseDirectionRemainingCacheExtent,
      cacheOrigin: (mainAxisExtent - centerOffset).clamp(-_calculatedCacheExtent!, 0.0),
    );
    if (result != 0.0)
      return -result;
  }
  // --------------------- å¸ƒå±€centerå’Œä¹‹åçš„å­å…ƒç´  ----------------------
  return layoutChildSequence(
    child: center,
    scrollOffset: math.max(0.0, -centerOffset),
    overlap: leadingNegativeChild == null ? math.min(0.0, -centerOffset) : 0.0,
    layoutOffset: centerOffset >= mainAxisExtent ? centerOffset: reverseDirectionRemainingPaintExtent,
    remainingPaintExtent: forwardDirectionRemainingPaintExtent,
    mainAxisExtent: mainAxisExtent,
    crossAxisExtent: crossAxisExtent,
    growthDirection: GrowthDirection.forward,
    advance: childAfter, // æ­£å‘æƒ…å†µï¼Œéå†ä¼šè°ƒç”¨ childAfter è·å–ä¸‹ä¸€ä¸ª child
    remainingCacheExtent: forwardDirectionRemainingCacheExtent,
    cacheOrigin: centerOffset.clamp(-_calculatedCacheExtent!, 0.0),
  );
}
```
æ³¨æ„ä¸€ä¸‹ï¼ŒcenterOffsetä¹Ÿå°±æ˜¯Sliverçš„åç§»æ˜¯å†…å®¹å¾€ä¸Šæ»šå°±å‡å°ï¼Œå†…å®¹å¾€ä¸‹æ»šå°±å¢å¤§ï¼›ä½†æ˜¯scrollOffsetæ˜¯å†…å®¹å¾€ä¸Šæ»šå°±å¢å¤§ï¼Œæ˜¯ç›¸åçš„ã€‚

`layoutChildSequence`æ˜¯æœ€ç»ˆå¸ƒå±€çš„æ–¹æ³•ï¼š
```dart
double layoutChildSequence({
  required RenderSliver? child, //ä»childï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªSliverï¼‰å¼€å§‹å¸ƒå±€
  required double scrollOffset, //ä½œä¸ºä¼ ç»™childçš„SliverConstraints.scrollOffsetæ•°æ®å‚è€ƒ
  required double overlap, //æ˜¯ä¼ ç»™ç¬¬ä¸€ä¸ªsliverçš„SliverConstraints.overlapï¼›ä¼ ç»™åç»­çš„sliverçš„overlapå°†è¢«ä¹‹å‰çš„childè¾“å‡ºçš„SliverGeometryå½±å“
  required double layoutOffset, //ç¬¬ä¸€ä¸ªsliverçš„å¸ƒå±€åç§»ï¼›ä¼šé€šè¿‡åç»­sliverçš„SliverGeometry.layoutExtentæ¥æ›´æ–°
  required double remainingPaintExtent, //ç¬¬ä¸€ä¸ªsliverçš„å‰©ä½™ç»˜åˆ¶èŒƒå›´ï¼›ä¼šé€šè¿‡åç»­sliverçš„SliverGeometry.layoutExtentæ¥æ›´æ–°
  required double mainAxisExtent, //viewportçš„ä¸»è½´èŒƒå›´ï¼Œæ¯”å¦‚é«˜åº¦
  required double crossAxisExtent, //viewportçš„äº¤å‰è½´èŒƒå›´ï¼Œæ¯”å¦‚å®½åº¦
  required GrowthDirection growthDirection,  //å¢é•¿æ–¹å‘
  required RenderSliver? Function(RenderSliver child) advance, //è·å–ä¸‹ä¸€ä¸ªsliver
  required double remainingCacheExtent, //å‰©ä½™ç¼“å­˜èŒƒå›´
  required double cacheOrigin,
}) {

  final double initialLayoutOffset = layoutOffset;
  final ScrollDirection adjustedUserScrollDirection =
      applyGrowthDirectionToScrollDirection(offset.userScrollDirection, growthDirection);
  double maxPaintOffset = layoutOffset + overlap;
  double precedingScrollExtent = 0.0;
  // å¾ªç¯å¤„ç†å„ä¸ªSliverï¼ˆå¯ä»¥ç”¨åªæœ‰ä¸€ä¸ª SliverList çš„æƒ…å†µç®€åŒ–æµç¨‹åˆ†æï¼‰
  while (child != null) {
    final double sliverScrollOffset = scrollOffset <= 0.0 ? 0.0 : scrollOffset;
    final double correctedCacheOrigin = math.max(cacheOrigin, -sliverScrollOffset);
    final double cacheExtentCorrection = cacheOrigin - correctedCacheOrigin;
    // -------------------- è°ƒç”¨Sliverçš„layout --------------------
    child.layout(SliverConstraints(
      axisDirection: axisDirection,
      growthDirection: growthDirection,
      userScrollDirection: adjustedUserScrollDirection,
      scrollOffset: sliverScrollOffset,
      precedingScrollExtent: precedingScrollExtent,
      overlap: maxPaintOffset - layoutOffset,
      remainingPaintExtent: math.max(0.0, remainingPaintExtent - layoutOffset + initialLayoutOffset),
      crossAxisExtent: crossAxisExtent,
      crossAxisDirection: crossAxisDirection,
      viewportMainAxisExtent: mainAxisExtent,
      remainingCacheExtent: math.max(0.0, remainingCacheExtent + cacheExtentCorrection),
      cacheOrigin: correctedCacheOrigin,
    ), parentUsesSize: true);

    // -------------------------- è·å¾— Sliver è¿”å›çš„ SliverGeometry ---------------------

    // BoxRenderObjectå¸ƒå±€åï¼Œä¼šè®¾ç½®sizeï¼Œparentä¼šæ ¹æ®å„ä¸ªchildçš„sizeæ¥ä½œä¸ºè‡ªå·±çš„sizeå‚è€ƒï¼Œæˆ–è€…å…¶ä»–childçš„ä½ç½®åç§»å‚è€ƒ
    // è€Œ Sliver çš„æƒ…å†µï¼Œæ˜¯è¾“å…¥SliverConstraintsï¼Œäº§ç”Ÿäº† SliverGeometry
    final SliverGeometry childLayoutGeometry = child.geometry!;
    if (childLayoutGeometry.scrollOffsetCorrection != null)
      // éœ€è¦è°ƒæ•´ä½ç½®ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œé‡æ–°å†æ¬¡æ‰§è¡Œå¸ƒå±€
      return childLayoutGeometry.scrollOffsetCorrection!;

    // è®¡ç®—æœ‰æ•ˆå¸ƒå±€åç§»é‡ effectiveLayoutOffset é€šè¿‡ layoutOffsetï¼ˆå½“å‰å¸ƒå±€åç§»åŸºå‡†ï¼‰ä¸ childLayoutGeometry.paintOriginï¼ˆå­Sliverè‡ªèº«çš„ç»˜åˆ¶åŸç‚¹åç§»ï¼‰ç›¸åŠ å¾—åˆ°ï¼Œä»£è¡¨å­Sliveråœ¨è§†å£åæ ‡ç³»ä¸­çš„å®é™…å¸ƒå±€ä½ç½®ã€‚
    final double effectiveLayoutOffset = layoutOffset + childLayoutGeometry.paintOrigin;
    // è®°å½• Sliver å¯¹åº”çš„å¸ƒå±€åç§»å€¼ï¼Œå­˜å‚¨åˆ° child çš„ parentData ä¸­
    if (childLayoutGeometry.visible || scrollOffset > 0) {
      // å¯è§æˆ–æ»šåŠ¨åç§»ä¸ºæ­£çš„å­Sliverï¼šç›´æ¥ä½¿ç”¨ effectiveLayoutOffset ä½œä¸ºå¸ƒå±€åç§»ï¼Œé€šè¿‡ updateChildLayoutOffset å­˜å‚¨åˆ°å­Sliverçš„ parentData ä¸­ï¼Œç¡®ä¿å¯è§å†…å®¹æ­£ç¡®å®šä½ã€‚
      updateChildLayoutOffset(child, effectiveLayoutOffset, growthDirection);
    } else {
      // ä¸å¯è§ä¸”æ»šåŠ¨åç§»éæ­£çš„å­Sliverï¼šæ­¤æ—¶ effectiveLayoutOffset å·²æ— æ„ä¹‰ï¼ˆå›  layoutExtent ä¸º0ï¼‰ï¼Œæ”¹ç”¨ -scrollOffset + initialLayoutOffset ä½œä¸ºåç§»é‡ã€‚è¿™æ˜¯ä¸ºäº†åˆ©ç”¨æŒç»­å¢é•¿çš„ scrollOffset æ¥å¤§è‡´ç»´æŒä¸å¯è§å­Sliverçš„é¡ºåºï¼Œç¡®ä¿åç»­æ»šåŠ¨æ—¶èƒ½æ­£ç¡®æ¢å¤å…¶ä½ç½®ã€‚
      updateChildLayoutOffset(child, -scrollOffset + initialLayoutOffset, growthDirection);
    }

    
    maxPaintOffset = math.max(effectiveLayoutOffset + childLayoutGeometry.paintExtent, maxPaintOffset);
    // scrollExtent æ˜¯å­ Sliver è´¡çŒ®çš„æ»šåŠ¨èŒƒå›´ï¼ˆå¦‚åˆ—è¡¨é¡¹çš„é«˜åº¦/å®½åº¦ï¼‰ã€‚å‡å»è¯¥å€¼åï¼ŒscrollOffset å˜ä¸ºä¸‹ä¸€ä¸ªå­ Sliver çš„èµ·å§‹æ»šåŠ¨ä½ç½®ã€‚
    scrollOffset -= childLayoutGeometry.scrollExtent;
    // ç´¯è®¡å½“å‰å­ Sliver ä¹‹å‰æ‰€æœ‰ Sliver çš„æ€»æ»šåŠ¨èŒƒå›´ã€‚
    precedingScrollExtent += childLayoutGeometry.scrollExtent;
    // æ›´æ–°ä¸‹ä¸€ä¸ªå­ Sliver çš„å¸ƒå±€èµ·å§‹ä½ç½®ã€‚
    layoutOffset += childLayoutGeometry.layoutExtent;
    if (childLayoutGeometry.cacheExtent != 0.0) {
      remainingCacheExtent -= childLayoutGeometry.cacheExtent - cacheExtentCorrection;
      cacheOrigin = math.min(correctedCacheOrigin + childLayoutGeometry.cacheExtent, 0.0);
    }
    // ç”¨äºç´¯è®¡æ€»æ»šåŠ¨èŒƒå›´ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨è§†è§‰æº¢å‡ºç­‰ï¼Œä¸ºè§†å£çš„æ»šåŠ¨è¾¹ç•Œè®¡ç®—å’Œæ¸²æŸ“ä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒ
    updateOutOfBandData(growthDirection, childLayoutGeometry);

    // å¾ªç¯ç»§ç»­å¯¹ä¸‹ä¸€ä¸ª child Sliver å¸ƒå±€
    child = advance(child);
  }
  return 0.0;
}
```

> **RenderViewport çš„å¸ƒå±€è€ƒè™‘çš„æ˜¯å¾ˆå¤šä¸ª Sliverï¼Œä½†æˆ‘ä»¬å¯ä»¥ä»¥ä»…ä¸€ä¸ª SliverList æ¥åˆ†ææ›´ç®€å•ï¼ˆå¯¹åº”ä½¿ç”¨ ListView çš„æƒ…å†µï¼‰**

> æ›´å…·ä½“çš„å¸ƒå±€æµç¨‹ï¼Œéœ€è¦åœ¨æ¯”å¦‚ SliverListã€SliverPersistentHeader ç­‰ç»„ä»¶å¯¹åº”çš„ `performLayout()` æ–¹æ³•ä¸­æŸ¥çœ‹

#### ç»˜åˆ¶
`paint`çš„æ ¸å¿ƒå°±æ˜¯è°ƒç”¨`_paintContents`
```dart
  @override
  void paint(PaintingContext context, Offset offset) {
    if (firstChild == null) {
      return;
    }
    if (hasVisualOverflow && clipBehavior != Clip.none) {
      _clipRectLayer.layer = context.pushClipRect(
        needsCompositing,
        offset,
        Offset.zero & size,
        _paintContents,
        clipBehavior: clipBehavior,
        oldLayer: _clipRectLayer.layer,
      );
    } else {
      _clipRectLayer.layer = null;
      _paintContents(context, offset);
    }
  }

  void _paintContents(PaintingContext context, Offset offset) {
    for (final RenderSliver child in childrenInPaintOrder) {
      if (child.geometry!.visible) {
        // paintOffsetOf æ–¹æ³•å°±æ˜¯ä» child çš„ parentData ä¸­è·å– paintOffsetï¼Œåœ¨ layoutChildSequence ä¸­å·²ç»è®¾ç½®
        context.paintChild(child, offset + paintOffsetOf(child));
      }
    }
  }
```

> æ›´å…·ä½“çš„ç»˜åˆ¶æµç¨‹ï¼Œéœ€è¦åœ¨å…·ä½“ Sliver ç»„ä»¶å¯¹åº”çš„ `paint(context, offset)` æ–¹æ³•ä¸­æŸ¥çœ‹

# å¸¸ç”¨æ»‘åŠ¨ç»„ä»¶
## SingleChildScrollView
æ²¡æœ‰æ‡’åŠ è½½å¤ç”¨æœºåˆ¶çš„å•ä¸ªwidgetçš„æ»šåŠ¨ç»„ä»¶ï¼Œå®ƒå†…éƒ¨å°±æ˜¯`Scrollable`å’Œä¸€ä¸ªç®€å•çš„`_SingleChildViewport`ç»„åˆè€Œæˆã€‚

## ScrollView
`ScrollView`æ˜¯å¸¸ç”¨çš„`ListView`ã€`GridView`ã€`CustomScrollView`çš„çˆ¶ç±»ï¼š
![ScrollViewç»§æ‰¿å…³ç³»å›¾](./å¼•ç”¨å›¾ç‰‡/ScrollViewç»§æ‰¿å…³ç³».png)

å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»„åˆäº†`Scrollable`å’Œ`Viewport`ï¼Œå­ç±»çš„é‡ç‚¹åˆ™æ˜¯å®ç°æ–¹æ³•ï¼š
```dart
// è¿”å› Sliver ç±»å‹çš„ Widget åˆ—è¡¨ï¼ŒScrollView ä¼šæŠŠå®ƒä»¬ä¼ ç»™ Viewport å¸ƒå±€å’Œç»˜åˆ¶
List<Widget> buildSlivers(BuildContext context);
```

## ListView
`ListView`ç»§æ‰¿è‡ª`BoxScrollView`ï¼Œç›´æ¥ä»æœ€å¸¸ç”¨çš„`ListView.builder`æ„é€ æ–¹æ³•å¼€å§‹åˆ†æï¼š
```dart
  ListView.builder({
    super.key,
    super.scrollDirection, // æ¨ªå‘æˆ–çºµå‘çš„æ»šåŠ¨æ–¹å‘ã€‚å†…éƒ¨ä¼šä¼ ç»™ Viewport ç­‰ä½¿ç”¨
    super.reverse, // æ˜¯å¦åå‘ï¼Œç”¨äºå’Œ scrollDirection å…±åŒå¾—åˆ° AxisDirection ï¼Œä¼šä¼ ç»™ SCrollableã€Viewport
    super.controller,
    super.primary,
    super.physics,
    super.shrinkWrap, // é»˜è®¤falseã€‚true è¡¨ç¤ºå°ºå¯¸ä¼šæ”¶ç¼©ä»¥åŒ…è£¹å…¶å†…å®¹çš„æ€»é«˜åº¦/å®½åº¦ï¼Œä½†æ€§èƒ½æ¶ˆè€—æ›´å¤§ï¼Œå› ä¸ºéœ€è¦è®¡ç®—æ‰€æœ‰childçš„å°ºå¯¸ (å³ä¾¿ä¸å¯è§) æ¥ç¡®å®šè‡ªèº«çš„æ€»å°ºå¯¸
    super.padding,
    this.itemExtent, // child çš„å›ºå®šé«˜åº¦ã€‚å¦‚æœè®¾ç½®å¯ä»¥æå‡æ€§èƒ½
    this.itemExtentBuilder,
    this.prototypeItem,
    required NullableIndexedWidgetBuilder itemBuilder,
    ChildIndexGetter? findChildIndexCallback,
    int? itemCount,
    bool addAutomaticKeepAlives = true,
    bool addRepaintBoundaries = true,
    bool addSemanticIndexes = true,
    super.cacheExtent,
    int? semanticChildCount,
    super.dragStartBehavior,
    super.keyboardDismissBehavior,
    super.restorationId,
    super.clipBehavior,
    super.hitTestBehavior,
  }) : childrenDelegate = SliverChildBuilderDelegate(
         itemBuilder,
         findChildIndexCallback: findChildIndexCallback,
         childCount: itemCount,
         addAutomaticKeepAlives: addAutomaticKeepAlives,
         addRepaintBoundaries: addRepaintBoundaries,
         addSemanticIndexes: addSemanticIndexes,
       ),
       super(semanticChildCount: semanticChildCount ?? itemCount);

  @override
  Widget buildChildLayout(BuildContext context) {
    if (itemExtent != null) {
      return SliverFixedExtentList(delegate: childrenDelegate, itemExtent: itemExtent!);
    } else if (itemExtentBuilder != null) {
      return SliverVariedExtentList(
        delegate: childrenDelegate,
        itemExtentBuilder: itemExtentBuilder!,
      );
    } else if (prototypeItem != null) {
      return SliverPrototypeExtentList(delegate: childrenDelegate, prototypeItem: prototypeItem!);
    }
    // å¤§å¤šæ•°æƒ…å†µå†…éƒ¨ä½¿ç”¨ SliverListï¼ŒæŒæœ‰ SliverChildBuilderDelegate
    return SliverList(delegate: childrenDelegate);
  }
```

ä»¥ä¸‹ 3 ä¸ªå±æ€§æŒ‰é¡ºåºä¼˜å…ˆçº§æ’åˆ—ï¼Œåœ¨ `ListView` å®ç°çš„ `buildChildLayout` ï¼ˆä¼šè¢« `buildSlivers` è°ƒç”¨ï¼‰ä¸­ä½¿ç”¨ï¼Œåªæœ‰å…¶ä¸­ä¸€ä¸ªç”Ÿæ•ˆï¼š
* `itemExtent`ï¼šchild çš„å›ºå®šé«˜åº¦ã€‚å¦‚æœè®¾ç½®å¯ä»¥æå‡æ€§èƒ½ã€‚
* `itemExtentBuilder`ï¼šä½¿ç”¨ index å’Œå½“å‰æ»šåŠ¨ä¿¡æ¯æ¥ç¡®å®šæ¯ä¸ª child çš„é«˜åº¦
* `prototypeItem`ï¼šå½“ `prototypeItem` ä¸ä¸ºç©ºæ—¶ï¼ŒListView ä¼šè‡ªåŠ¨è®¡ç®—è¯¥åŸå‹ widget çš„å°ºå¯¸ï¼ˆæ²¿æ»šåŠ¨æ–¹å‘çš„é•¿åº¦ï¼Œå¦‚å‚ç›´æ»šåŠ¨æ—¶çš„é«˜åº¦ã€æ°´å¹³æ»šåŠ¨æ—¶çš„å®½åº¦ï¼‰ï¼Œå¹¶å°†åˆ—è¡¨ä¸­æ‰€æœ‰å­é¡¹çš„å°ºå¯¸å¼ºåˆ¶è®¾ç½®ä¸ºä¸åŸå‹ä¸€è‡´ã€‚é€‚ç”¨äºå­é¡¹å°ºå¯¸ä¾èµ–å†…å®¹ä½†éœ€ç»Ÿä¸€çš„åœºæ™¯ï¼Œé¿å…`itemExtent`ç¡¬ç¼–ç æ•°å€¼ã€‚

> ğŸ‘†è¿™3ä¸ªå±æ€§ä¼šåˆ†åˆ«åœ¨å†…éƒ¨ä½¿ç”¨ä¸åŒçš„ Sliver ç»„ä»¶æ¥å®ç°

* `itemBuilder`ï¼šè¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œäº†è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆAPIè®¾è®¡å¯ä»¥è¿”å›nullï¼Ÿä¾‹å¦‚å®ç°å¸¦è¿‡æ»¤åŠŸèƒ½çš„åˆ—è¡¨æ—¶ï¼Œå¯ä»¥åœ¨ä¸ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„ç´¢å¼•ä½ç½®è¿”å›nullï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨è·³è¿‡è¿™äº›ä½ç½®ã€‚æˆ–è€…åœ¨åŠ è½½æ›´å¤šæ•°æ®è¿‡ç¨‹ä¸­ï¼Œå¯¹äºå°šæœªåŠ è½½å®Œæˆçš„ç´¢å¼•å¯ä»¥è¿”å›null
* `itemCount`ï¼š`null` è¡¨ç¤ºåˆ—è¡¨æ˜¯æ— é™çš„ï¼Œbuilderä¼šæŒç»­è¢«è°ƒç”¨ç›´åˆ°è¿”å›nullï¼Œé€‚ç”¨äºå®ç°æ— é™æ»šåŠ¨åˆ—è¡¨ï¼ˆå¦‚ç¤¾äº¤åª’ä½“æ—¶é—´çº¿ï¼‰ï¼›`0` è¡¨ç¤ºåˆ—è¡¨ä¸ºç©ºï¼Œæ­¤æ—¶builderä¸ä¼šè¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
* `findChildIndexCallback`ï¼šç”¨äºåˆ—è¡¨é¡¹å¤ç”¨çš„é«˜çº§åŠŸèƒ½ï¼Œåœ¨ item ä½¿ç”¨`key`çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡`key`æŸ¥æ‰¾itemçš„indexï¼Œä»è€Œå¤ç”¨å¯¹åº”çš„Elementã€‚ï¼ˆå…·ä½“å¯ä»¥åœ¨ä¸‹é¢æºç ä»‹ç»ä¸­äº†è§£ï¼‰
* `addAutomaticKeepAlives`ï¼šé»˜è®¤`true`ï¼Œåªè¦ item çš„ State æ··å…¥`AutomaticKeepAliveClientMixin`å¹¶é‡å†™`wantKeepAlive`è¿”å›`true`å³å¯ç”Ÿæ•ˆã€‚å¯ä»¥è®©itemæ»‘å‡ºå¯è§èŒƒå›´åä¾æ—§ç¼“å­˜çŠ¶æ€ã€‚
* `addRepaintBoundaries`ï¼šé»˜è®¤`true`ï¼Œæ˜¯å¦ä¸ºæ¯ä¸ªitemè‡ªåŠ¨åŒ…è£¹ä¸€ä¸ª `RepaintBoundary`ï¼Œç”¨äºä¼˜åŒ–æ€§èƒ½
* `cacheExtent`ï¼š`double?`ç±»å‹ï¼Œè®¾ç½® Viewport çš„é¢„åŠ è½½åŒºåŸŸå¤§å°ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œ`RenderViewport` ä¸­ä¼šé»˜è®¤ä½¿ç”¨ 250
* `bool addSemanticIndexes`å’Œ`int? semanticChildCount`ï¼šéƒ½æ˜¯ä¸æ— éšœç¢è®¿é—®ï¼ˆAccessibilityï¼‰ ç›¸å…³çš„å±æ€§ï¼Œä¸»è¦ç”¨äºå¸®åŠ©å±å¹•é˜…è¯»å™¨ç­‰è¾…åŠ©æŠ€æœ¯æ­£ç¡®è¯†åˆ«å’Œæ’­æŠ¥æ»šåŠ¨è§†å›¾ä¸­çš„å†…å®¹ã€‚æœ‰äº›åœºæ™¯ä¸‹ï¼Œæ»šåŠ¨è§†å›¾çš„å­å…ƒç´ å¯èƒ½åŒ…å«éè¯­ä¹‰åŒ–å†…å®¹ï¼ˆå¦‚åˆ†éš”çº¿ã€ç©ºç™½å ä½ç¬¦ç­‰ï¼‰ï¼Œ`semanticChildCount` ç”¨äºæŒ‡å®šå®é™…éœ€è¦è¢«æ— éšœç¢æœåŠ¡è¯†åˆ«çš„æœ‰æ•ˆå­å…ƒç´ æ•°é‡ã€‚`addSemanticIndexes`æ§åˆ¶æ˜¯å¦ä¸ºæ»šåŠ¨è§†å›¾çš„å­å…ƒç´ è‡ªåŠ¨ç”Ÿæˆè¯­ä¹‰åŒ–ç´¢å¼•ã€‚è¯­ä¹‰åŒ–ç´¢å¼•å¸®åŠ©æ— éšœç¢æœåŠ¡è¯†åˆ«å­å…ƒç´ çš„ä½ç½®ï¼ˆå¦‚â€œç¬¬3é¡¹ï¼Œå…±5é¡¹â€ï¼‰ï¼Œæå‡å±å¹•é˜…è¯»å™¨çš„æ’­æŠ¥å‡†ç¡®æ€§ã€‚


### ListView æºç åˆ†æ
ä»¥`ListView.builder`çš„æƒ…å†µä¸ºä¾‹ï¼Œ`buildChildLayout`æ–¹æ³•ä¼šæ„é€ `SliverList`ï¼Œå¹¶æŒæœ‰`SliverChildBuilderDelegate`ã€‚

```dart
// ----------------- æ„é€ æµç¨‹ ----------------- 
çˆ¶ç±» ScrollView.build() æ–¹æ³•ï¼ˆå†…å®¹æ˜¯è°ƒç”¨ä»¥ä¸‹æµç¨‹ï¼Œå¾—åˆ° widget ä¼ ç»™ viewportï¼‰
    â†“
çˆ¶ç±» BoxScrollView.buildSlivers() è°ƒç”¨ buildChildLayout()
    â†“
ListView çš„ buildChildLayout()ï¼Œæ„é€  SliverList

// ---------------- æ„é€ æµç¨‹çš„æ ¸å¿ƒå°±æ˜¯æ„é€ äº† Scrollable -- Viewport --  SliverList 
```

#### SliverList æºç æµç¨‹
```dart
// --------------- widget / Element / Render ç»“æ„ --------------------
class SliverList extends SliverMultiBoxAdaptorWidget {

  @override
  RenderSliverList createRenderObject(BuildContext context) {
    final SliverMultiBoxAdaptorElement element = context as SliverMultiBoxAdaptorElement;
    
    // RenderSliverList æŒæœ‰çš„ childManager å°±æ˜¯ SliverMultiBoxAdaptorElement
    return RenderSliverList(childManager: element);
  }
}


// -------------- RenderSliverList å¸ƒå±€æµç¨‹ -----------------

RenderSliverList.performLayout ï¼ˆä¸è´´ä»£ç ï¼Œç›´æ¥æ–‡å­—æè¿°ï¼‰
```
`RenderSliverList.performLayout`æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š
1. åˆå§‹åŒ–ä¸å‡†å¤‡å·¥ä½œ
  * è·å–çº¦æŸä¿¡æ¯ï¼šä» `SliverConstraints` ä¸­æå–æ»šåŠ¨åç§»é‡ï¼ˆ`scrollOffset`ï¼‰ã€ç¼“å­˜åŒºåŸŸå¤§å°ï¼ˆ`remainingCacheExtent`ï¼‰ç­‰å…³é”®å‚æ•°ï¼Œç¡®å®šéœ€è¦å¸ƒå±€çš„ç›®æ ‡èŒƒå›´ï¼ˆ`targetEndScrollOffset` = æ»šåŠ¨åç§»é‡ + å‰©ä½™ç¼“å­˜åŒºåŸŸï¼‰ã€‚
  * åˆå§‹åŒ–çŠ¶æ€ï¼šæ ‡è®°å¸ƒå±€å¼€å§‹ï¼ˆ`childManager.didStartLayout()`ï¼‰ï¼Œé‡ç½®ä¸‹æº¢çŠ¶æ€ï¼ˆ`setDidUnderflow(false)`ï¼‰ï¼Œå¹¶åˆå§‹åŒ–ç”¨äºè·Ÿè¸ªå¾…æ¸…ç†å­ç»„ä»¶çš„intå˜é‡ï¼ˆ`leadingGarbage`ã€`trailingGarbage`ï¼‰ã€‚

2. ç¡®ä¿åˆå§‹å­ç»„ä»¶å­˜åœ¨
  * å¦‚æœå½“å‰æ²¡æœ‰å­ç»„ä»¶ï¼ˆ`firstChild == null`ï¼‰ï¼Œå°è¯•é€šè¿‡ `addInitialChild()` æ·»åŠ ç¬¬ä¸€ä¸ªå­ç»„ä»¶ã€‚è‹¥æ·»åŠ å¤±è´¥ï¼ˆæ— æ•°æ®ï¼‰ï¼Œåˆ™è¿”å›ç©ºå‡ ä½•ä¿¡æ¯ï¼ˆ`SliverGeometry.zero`ï¼‰ã€‚

3. ä¿®å¤å¸ƒå±€åç§»å¼‚å¸¸ï¼ˆå¤„ç†å­ç»„ä»¶é‡æ’ï¼‰
  * è‹¥é¦–ä¸ªå­ç»„ä»¶çš„å¸ƒå±€åç§»é‡ï¼ˆ`layoutOffset`ï¼‰ä¸º nullï¼ˆå¯èƒ½å› å­ç»„ä»¶é‡æ’å¯¼è‡´ï¼‰ï¼Œéå†æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå…·æœ‰æœ‰æ•ˆåç§»é‡çš„å­ç»„ä»¶ï¼Œå¹¶æ¸…ç†å‰é¢çš„æ— æ•ˆå­ç»„ä»¶ï¼ˆ`collectGarbage`ï¼‰ã€‚
  * è‹¥æ‰¾ä¸åˆ°æœ‰æ•ˆåç§»é‡çš„å­ç»„ä»¶ï¼Œé‡æ–°æ·»åŠ åˆå§‹å­ç»„ä»¶å¹¶å¤„ç†è¾¹ç•Œæƒ…å†µã€‚

4. å®šä½æ»šåŠ¨èµ·å§‹ä½ç½®çš„å­ç»„ä»¶ï¼ˆç¡®ä¿ä»Sliverå¯è§å’Œç¼“å­˜èŒƒå›´çš„å¼€å§‹éƒ¨åˆ†å­˜åœ¨childï¼Œæ¯”å¦‚å†…å®¹å¾€ä¸‹æ»‘çš„æƒ…å†µï¼Œéœ€è¦å¾€å‰é¢æ·»åŠ itemï¼‰
  * å‘ä¸ŠæŸ¥æ‰¾å¯è§åŒºåŸŸèµ·ç‚¹ï¼šä»é¦–ä¸ªå­ç»„ä»¶å¼€å§‹ï¼Œè‹¥å…¶æ»šåŠ¨åç§»é‡å¤§äºå½“å‰ `scrollOffset`ï¼Œåˆ™ä¸æ–­æ’å…¥å¹¶å¸ƒå±€å‰æ–¹çš„å­ç»„ä»¶ï¼ˆ`insertAndLayoutLeadingChild`ï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°åç§»é‡å°äºç­‰äº `scrollOffset` å°±åœæ­¢ã€‚
  * å¤„ç†æ»šåŠ¨åˆ°é¡¶éƒ¨çš„æƒ…å†µï¼šè‹¥ `scrollOffset` æ¥è¿‘ 0ï¼Œç¡®ä¿åˆ—è¡¨ä»ç¬¬ä¸€ä¸ªå­ç»„ä»¶å¼€å§‹å¸ƒå±€ï¼Œé¿å…å› æ»šåŠ¨åç§»è®¡ç®—è¯¯å·®å¯¼è‡´çš„ç©ºç™½ã€‚

5. å¸ƒå±€å¯è§åŒºåŸŸå†…çš„å­ç»„ä»¶
  * åˆå§‹åŒ–å¸ƒå±€èŒƒå›´ï¼šæ ‡è®°å·²å¸ƒå±€çš„é¦–å°¾å­ç»„ä»¶ï¼ˆ`leadingChildWithLayout`ã€`trailingChildWithLayout`ï¼‰ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå­ç»„ä»¶å·²å¸ƒå±€ã€‚
  * éå†å¹¶å¸ƒå±€å­ç»„ä»¶ï¼šé€šè¿‡ `advance()` å‡½æ•°æŒ‰é¡ºåºéå†å­ç»„ä»¶ï¼Œè®¡ç®—æ¯ä¸ªå­ç»„ä»¶ç›¸å¯¹äº SliverList çš„å¸ƒå±€åç§»é‡ï¼ˆ`layoutOffset`ï¼‰ï¼Œå¹¶ç¡®ä¿è¦†ç›–ä» `scrollOffset` åˆ° `targetEndScrollOffset` çš„åŒºåŸŸï¼ˆå¯è§åŒºåŸŸ + ç¼“å­˜åŒºåŸŸï¼‰ã€‚
  * `advance()` å‡½æ•°è´Ÿè´£ï¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªå­ç»„ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ç¼ºå¤±åˆ™æ’å…¥å¹¶è°ƒç”¨ child çš„ `layout()` æ–¹æ³•å¸ƒå±€ï¼›æ›´æ–°å½“å‰å­ç»„ä»¶çš„`layoutOffset`åç§»é‡å’Œå½“å‰æœ€åä¸€ä¸ªitemçš„æœ«å°¾åç§»é‡ï¼ˆ`endScrollOffset`ï¼‰ã€‚`endScrollOffset` ç”¨äºè®¡ç®—æ˜¯å¦è¿˜éœ€è¦å¾€åé¢æ·»åŠ itemã€‚
  * å¸ƒå±€å®Œå¯è§åŒºåŸŸçš„ itemï¼Œ`child`å°±æ˜¯æœ€åçš„ä¸€ä¸ª item
  * `advance()`å¯¹å­˜åœ¨çš„itemæ›´æ–°`layoutOffset`ï¼Œå¹¶è®¡ç®—æ–°çš„`endScrollOffset`ï¼Œè¿˜æœ‰å¦å¤–çš„ä½œç”¨å°±æ˜¯åœ¨ä¸‹é¢çš„æ¸…ç†ä¸å¯è§itemé€»è¾‘ä¸­ä½¿ç”¨

6. æ¸…ç†ä¸å¯è§å­ç»„ä»¶
  * ç»Ÿè®¡è¶…å‡ºå¯è§/ç¼“å­˜åŒºåŸŸçš„å‰åå­ç»„ä»¶æ•°é‡ï¼ˆ`leadingGarbage`ï¼šå‰æ–¹ä¸å¯è§ï¼Œ`trailingGarbage`ï¼šåæ–¹ä¸å¯è§ï¼‰ï¼Œé€šè¿‡ `collectGarbage` æ¸…ç†è¿™äº›å­ç»„ä»¶ä»¥é‡Šæ”¾èµ„æºã€‚
  * æ¯”å¦‚å†…å®¹å¾€ä¸Šæ»‘åŠ¨ï¼Œitem åç§»æ¯” SliverList çš„åç§»æ›´å°ï¼ˆè€ƒè™‘äº†ç¼“å­˜åŒºåŸŸï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸å¯è§ä¹Ÿä¸éœ€è¦ç¼“å­˜ï¼Œå°±éœ€è¦æ¸…ç†
  * æ¯”å¦‚å†…å®¹å¾€ä¸‹æ»‘åŠ¨ï¼Œä¸‹é¢å°±ä¼šæœ‰ä¸€äº›ä¸å¯è§ä¹Ÿä¸éœ€è¦ç¼“å­˜çš„itemï¼ˆ`child` ä¹‹åçš„ item ï¼‰éœ€è¦æ¸…ç†ã€‚

7. è®¡ç®—å¹¶è¿”å›å‡ ä½•ä¿¡æ¯
  * ä¼°ç®—æœ€å¤§æ»šåŠ¨èŒƒå›´ï¼šè‹¥å·²éå†åˆ°æœ€åä¸€ä¸ªå­ç»„ä»¶ï¼ˆ`reachedEnd`è®¾ä¸ºtrueï¼‰ï¼Œåˆ™æœ€å¤§æ»šåŠ¨èŒƒå›´ä¸ºå½“å‰ç»“æŸåç§»é‡ï¼›å¦åˆ™é€šè¿‡ `childManager.estimateMaxScrollOffset` ä¼°ç®—ã€‚
  * è®¡ç®—ç»˜åˆ¶åŒºåŸŸå’Œç¼“å­˜åŒºåŸŸï¼šé€šè¿‡ `calculatePaintOffset()` å’Œ `calculateCacheOffset()` æ–¹æ³•è®¡ç®—å½“å‰å¯è§åŒºåŸŸå’Œç¼“å­˜åŒºåŸŸçš„å¤§å°ã€‚
  * è¿”å›å‡ ä½•ä¿¡æ¯ï¼šè®¾ç½® `SliverGeometry`ï¼ŒåŒ…å«æ»šåŠ¨èŒƒå›´ã€ç»˜åˆ¶èŒƒå›´ã€ç¼“å­˜èŒƒå›´ç­‰ï¼Œå‘ŠçŸ¥çˆ¶ç»„ä»¶å¦‚ä½•æ¸²æŸ“å’Œæ»šåŠ¨å½“å‰ sliverã€‚

#### ä¸¾ä¾‹åˆ†æ ListView çš„å¤ç”¨é€»è¾‘
```dart
// item å†…éƒ¨ç»´æŠ¤ç‚¹å‡»æ•°é‡çŠ¶æ€
class _CounterItemState extends State<CounterItem> {
  int _count = 0;

  @override
  Widget build(BuildContext context) {
    return ListTile(
      title: Text('${widget.label}: $_count'),
      trailing: IconButton(
        icon: const Icon(Icons.add),
        onPressed: () {
          setState(() {
            _count++;
          });
        },
      ),
    );
  }
}

// ä½¿ç”¨ ListView æ„é€  CounterItem åˆ—è¡¨UI
class ProblemExample1 extends StatefulWidget {
  @override
  State<ProblemExample1> createState() => _ProblemExample1State();
}

class _ProblemExample1State extends State<ProblemExample1> {
  List<String> items = ['A', 'B', 'C'];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('é—®é¢˜æ¼”ç¤º')),
      body: ListView.builder(
        itemCount: items.length,
        itemBuilder: (context, index) {
          return CounterItem(
              // ä½¿ç”¨æ•°æ®æœ¬èº«ä½œä¸º key
              key: ValueKey(items[index]), label: items[index]);
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          setState(() {
            // ç‚¹å‡»ï¼Œåœ¨å¤´éƒ¨å¢åŠ ä¸€ä¸ª CounterItem
            items.insert(0, 'X');
          });
        },
        child: const Icon(Icons.add),
      ),
    );
  }
}
```
ç‚¹å‡» floatingAction æŒ‰é’®ï¼Œåœ¨å¤´éƒ¨å¢åŠ ä¸€ä¸ªitemï¼Œä¹Ÿå°±æ˜¯ä»`[A, B, C]`å˜ä¸º`[X, A, B, C]`ã€‚

å› ä¸ºä½¿ç”¨äº†keyï¼ŒæŒ‰ç…§ç›´è§‰æ¥è¯´ï¼Œ`X`ä¼šæ–°å»ºï¼Œä½†`A`ã€`B`ã€`C`åº”è¯¥éƒ½å¯ä»¥å¤ç”¨ã€‚**ä½†å®é™…æµ‹è¯•å‘ç°ï¼ŒAã€Bã€Céƒ½æ˜¯æ–°å»ºçš„**

```dart
// åˆå§‹æ„é€ æµç¨‹

RenderSliverList.performLayout
  
  // æ„é€ ç¬¬ä¸€ä¸ª item
  RenderSliverList.addInitialChild() // æ„é€  index ä¸º 0 çš„ item
    â†“
  SliverMultiBoxAdaptorElement.createChild()
    â†“
  SliverMultiBoxAdaptorElement._build()
    â†“
  SliverChildBuilderDelegate.build() // è°ƒç”¨æˆ‘ä»¬ä¼ å…¥çš„ `itemBuilder`

  // æ„é€ å…¶ä»– item
  RenderSliverList.performLayout.advance()
    â†“ // è°ƒç”¨çˆ¶ç±»æ–¹æ³•
  RenderSliverMultiBoxAdaptor.insertAndLayoutChild()
    â†“
  SliverMultiBoxAdaptorElement.createChild()
    â†“
  SliverChildBuilderDelegate.build() // åŒæ ·è°ƒç”¨æˆ‘ä»¬ä¼ å…¥çš„ `itemBuilder`

// æ„é€ çš„ item å¯¹åº”çš„ element éƒ½ä¼šç¼“å­˜åœ¨ _childElements Map ä¸­
```

å½“ç‚¹å‡»æŒ‰é’®ï¼Œåœ¨å¤´éƒ¨å¢åŠ ä¸€ä¸ª item æ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
```dart
// rebuild æµç¨‹

SliverMultiBoxAdaptorElement.performRebuild()
  // 1. item ä½¿ç”¨äº† key å¹¶ä¸”ä½¿ç”¨ findChildIndexCallback çš„æƒ…å†µï¼Œä¼šå…ˆæ ¹æ®é€šè¿‡ key è¿”å›çš„ indexï¼Œ
  // æ¥æŠŠ _childElements ä¸­ç¼“å­˜çš„ item é‡æ–°è®¾ç½®ä¸ºå¯¹åº”è¿”å›çš„ index
  
  // 2. å¦åˆ™ï¼Œä»ç„¶æŒ‰ç…§åŸæœ¬çš„å¯¹åº”å…³ç³»

  // è¿™ä¸¤ç§æƒ…å†µï¼Œéƒ½ä¼šæŠŠå­çº§ element æ”¾åˆ° newChildren map ä¸­ã€‚æ­¤æ—¶ï¼ŒnewChildren ä¸­æ”¾çš„ä»ç„¶æ˜¯åŸæœ¬çš„ elementï¼Œåªæ˜¯ index ä¿¡æ¯å¯èƒ½å› ä¸º key å’Œ findChildIndexCallback çš„é…åˆè€Œå˜åŒ–


  // 3. éå† element æ‰§è¡Œ processElement
SliverMultiBoxAdaptorElement.performRebuild.processElement(int index) {
  _currentlyUpdatingChildIndex = index;
  if (_childElements[index] != null && _childElements[index] != newChildren[index]) {
    // ç»è¿‡å‰é¢çš„æµç¨‹ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ findChildIndexCallback ï¼Œå…¶å® _childElements å’Œ newChildren æ˜¯ç›¸åŒçš„ï¼Œ
    // æ‰€ä»¥è¿™é‡Œåªæœ‰ ä½¿ç”¨ findChildIndexCallback å¯¼è‡´ index å¯¹åº”çš„ element å˜åŒ–ï¼Œæ‰ä¼šæ‰§è¡Œ updateChildï¼Œä¼  null è¡¨ç¤ºç§»é™¤
    _childElements[index] = updateChild(_childElements[index], null, index);
    childrenUpdated = true;
  }

  // æ„é€ widgetï¼Œæ‰§è¡Œ updateChild
  final Element? newChild = updateChild(
    newChildren[index],
    _build(index, adaptorWidget),
    index,
  );
  if (newChild != null) {
    // child æ˜¯å¦å‘ç”Ÿå˜äº†
    childrenUpdated = childrenUpdated || _childElements[index] != newChild;
    // è®¾ç½®æ–°çš„ element ï¼ˆå¯èƒ½æ˜¯å¤ç”¨çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯æ–°å»ºçš„ï¼‰
    _childElements[index] = newChild;
    // ...
  } else {
    // æ²¡æœ‰ç”Ÿæˆchildï¼Œæ¯”å¦‚ itemCount å˜å°äº†
    childrenUpdated = true;
    _childElements.remove(index);
  }  
}
// è¿™é‡Œçš„æµç¨‹ä¼šæ„é€ å’ŒåŸæœ¬æ•°é‡ç›¸åŒçš„ elementï¼Œå°±æ˜¯æ„é€  [X, A, B]ï¼Œæ¯ä¸ªè°ƒç”¨ updateChildï¼Œå†…éƒ¨æ¯”è¾ƒ keyï¼Œå› ä¸ºéƒ½æ˜¯ç›¸åŒ index çš„æ¥æ¯”è¾ƒï¼ŒåŸæœ¬çš„ index 0ï¼ˆkey Aï¼‰ å¯¹åº” ç°åœ¨çš„ index 0ï¼ˆkey Aï¼‰ï¼Œå…¶ä»–åŒç†ï¼Œä¼šå‘ç°æ¯ä¸ª key éƒ½ä¸èƒ½å¯¹åº”ä¸Šï¼Œæ‰€ä»¥éƒ½ä¸èƒ½å¤ç”¨ã€‚
```
**è¿™é‡Œå°±å¯ä»¥çŸ¥é“ä¸ºä»€ä¹ˆä½¿ç”¨äº† `key`ï¼Œåœ¨å¤´éƒ¨æ–°å¢ item Xï¼Œå´ä¸èƒ½å¤ç”¨åŸæœ¬çš„ item Aã€Bã€Cçš„åŸå› ã€‚åè€Œä¸ä½¿ç”¨ keyï¼Œæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå› ä¸ºç±»å‹ç›¸åŒå³å¯å¤ç”¨ã€‚** é™¤éä½¿ç”¨ key ï¼Œå¹¶ä¸”ä½¿ç”¨`findChildIndexCallback`æ‰å¯ä»¥å®ç°è¿™ç§æƒ…å†µçš„å¤ç”¨ã€‚

æ­¤æ—¶æ„é€ äº† Xã€Aã€Bï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ„å»º Cï¼Œå®ƒä¼šåœ¨ rebuild ä¹‹åï¼Œæ‰§è¡Œå¸ƒå±€å‘ç°è¿˜æœ‰å‰©ä½™ç©ºé—´çš„æ—¶å€™åˆ›å»ºï¼š
```dart
RenderSliverList.performLayout.advance()
   â†“
RenderSliverMultiBoxAdaptor.insertAndLayoutChild() // å’Œåˆå§‹æ„é€ æµç¨‹ä¸€æ ·ï¼Œæ„é€ 
   â†“
SliverMultiBoxAdaptorElement.createChild()
   â†“
updateChild() // æ ¹æ®æ„é€ çš„ widget å†³å®šå¤ç”¨æˆ–æ–°å»º elementã€‚æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯æ–°å»ºï¼Œå› ä¸º _childElements[3] ä¸º null
```

**æ€»ç»“å¤ç”¨é€»è¾‘å¦‚ä¸‹ï¼š**
1. StatefulWidget å¯¹åº”çš„ State å¯¹è±¡ä¼šè¢« StatefulElement æŒæœ‰ï¼ŒStatefulElementå¤ç”¨æ—¶ï¼ŒState å¯¹è±¡ä¹Ÿå¤ç”¨ï¼Œå°±å¯èƒ½å¯¼è‡´çŠ¶æ€é”™ä¹±ã€‚
2. `ListView`çš„ item æ²¡æœ‰ä½¿ç”¨ `key` çš„æƒ…å†µä¸‹ï¼Œåªè¦ç±»å‹ä¸€æ ·å°±å¯ä»¥å¤ç”¨ï¼Œä½†åªè¦ä½ç½®å˜åŒ–ï¼Œä¼šå‡ºç°çŠ¶æ€é”™ä¹±çš„æƒ…å†µ
3. å¦‚æœ`ListView`çš„ item ä½¿ç”¨ `key`ï¼Œåªè¦ä½ç½®å˜åŒ–ï¼Œå°±ä¸èƒ½å¤ç”¨
4. å¦‚æœ`ListView`çš„ item ä½¿ç”¨ `key` å¹¶ä¸”ä½¿ç”¨äº† `findChildIndexCallback`ï¼Œå¯ä»¥å®ç°ä½ç½®å˜åŒ–ä¹Ÿèƒ½å¤ç”¨
5. **å¦‚æœ item æ²¡æœ‰ä½¿ç”¨StatefulWidgetï¼Œæˆ–è€…è¯´çŠ¶æ€å®Œå…¨ç”±å¤–éƒ¨æ•°æ®æ¥æ§åˆ¶ï¼Œå°±ä¸ä¼šæœ‰å¤ç”¨é—®é¢˜ã€‚æ‰€ä»¥å®é™…é¡¹ç›®ä¸­ï¼Œæ›´å»ºè®®å°†çŠ¶æ€æå‡åˆ°å¤–éƒ¨ï¼Œå®Œå…¨é¿å…çŠ¶æ€å¤ç”¨é”™ä¹±é—®é¢˜**


#### ListView ä¸­çš„ KeepAlives
```dart
// æ„é€ é˜¶æ®µ

SliverChildBuilderDelegate.build // æ„é€  item widget
   â†“
AutomaticKeepAlive(child) // å°† child widge åŒ…è£¹åœ¨ AutomaticKeepAlive ä¸­
   â†“
KeepAlive // å†…éƒ¨æ„é€  KeepAliveï¼ŒåŒ…è£¹ childï¼Œè®¾ç½® keepAlive åˆ° ParentData ä¸­


// ä½¿ç”¨é˜¶æ®µ
RenderSliverMultiBoxAdaptor.collectGarbage()
    â†“
_destroyOrCacheChild()
// å¦‚æœ keepAlive ä¸º trueï¼Œåˆ™ä¼šç¼“å­˜åˆ° _keepAliveBucket Map ä¸­ã€‚

// åœ¨ _createOrObtainChild æ—¶ï¼Œä¼šå…ˆå°è¯•ä» _keepAliveBucket ä¸­è·å– element æ¥å¤ç”¨

```
> ä½†æ˜¯æ²¡æœ‰Androidé‡Œé¢çš„ç¼“å­˜æ± å¤§å°é™åˆ¶ï¼Œæ‰€ä»¥å¦‚æœåˆ—è¡¨å¾ˆé•¿ï¼Œä¼šå ç”¨è¾ƒå¤šçš„å†…å­˜ã€‚

## GridView
`GridView` ä¹Ÿç»§æ‰¿äº† `BoxScrollView`ï¼Œå’Œ `ListView` ä¸»è¦åŒºåˆ«å°±æ˜¯å¸ƒå±€ä¸åŒï¼Œæ‰€ä»¥ä¸å†å…·ä½“åˆ†æ

## PageView
ä½¿ç”¨äº†`Scrollable`ã€`Viewport`ã€`SliverFillViewport`ç»„åˆï¼Œå†…éƒ¨å°†ä½¿ç”¨`RenderSliverFillViewport`æ‰§è¡Œå¸ƒå±€å’Œç»˜åˆ¶ã€‚

## CustomScrollView
`ListView`å’Œ`GridView`ç»§æ‰¿è‡ª`BoxScrollView`ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦åœ¨å†…éƒ¨ä½¿ç”¨`SliverList`ã€`SliverGrid`æ¥åŒ…è£¹æ™®é€šçš„ Box å¸ƒå±€ç»„ä»¶ã€‚

è€Œ`CustomScrollView`æ˜¯ç”¨æ¥ç›´æ¥åŒ…è£¹ `Sliver` ç³»åˆ—ç»„ä»¶çš„æ»šåŠ¨å®¹å™¨ï¼Œç›¸æ¯” ListView/GridView æ›´é€‚åˆå®ç°æ··åˆå¤šç§æ»šåŠ¨å¸ƒå±€ã€‚
å®ƒåˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥å®¹çº³ `Sliver` ç³»åˆ—ç»„ä»¶çš„æ»šåŠ¨è§†å£ (Viewport)ï¼Œç»§æ‰¿è‡ª `ScrollView`ï¼Œåªæ˜¯é‡å†™äº† `buildSlivers()` ï¼Œè¿”å›æ„é€ å‚æ•°ä¼ å…¥çš„ `slivers` - Sliverç»„ä»¶åˆ—è¡¨ã€‚

Flutterè¦å®ç°å¤šç±»å‹å¸ƒå±€ï¼Œæ›´åŠ æ–¹ä¾¿ï¼Œç›´æ¥æ·»åŠ å„ç§Sliverå³å¯ã€‚
```dart
CustomScrollView(
  slivers: [
    // 1. å¯æŠ˜å çš„ AppBar
    SliverAppBar(
      expandedHeight: 200,
      flexibleSpace: FlexibleSpaceBar(
        title: Text('åŠ¨æ€æ ‡é¢˜'),
        background: Image.network(...),
      ),
      floating: true,
    ),
    
    // 2. å›ºå®šæ ‡é¢˜
    SliverPersistentHeader(
      delegate: _StickyHeaderDelegate('åˆ†ç±»1'),
      pinned: true,
    ),
    
    // 3. ç½‘æ ¼å†…å®¹
    SliverGrid(
      delegate: SliverChildBuilderDelegate(
        (context, index) => ProductItem(index),
        childCount: 20,
      ),
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2,
        mainAxisSpacing: 10,
        crossAxisSpacing: 10,
      ),
    ),
    
    // 4. å¦ä¸€ä¸ªæ ‡é¢˜
    SliverPersistentHeader(
      delegate: _StickyHeaderDelegate('åˆ†ç±»2'),
      pinned: true,
    ),
    
    // 5. åˆ—è¡¨å†…å®¹
    SliverList(
      delegate: SliverChildBuilderDelegate(
        (context, index) => ListTile(title: Text('Item $index')),
        childCount: 50,
      ),
    ),
    
    // 6. åº•éƒ¨åŠ è½½æ›´å¤š
    SliverToBoxAdapter(
      child: LoadingMoreWidget(),
    ),
  ],
)
```

## å…¶ä»–Sliver
* SliverFixedExtentListï¼šå›ºå®šé«˜åº¦åˆ—è¡¨ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
* SliverFillRemainingï¼šå¡«å……å‰©ä½™ç©ºé—´
* SliverToBoxAdapterï¼šåŒ…è£…æ™®é€š Widget ä¸º Sliver
* SliverAppBarï¼šå¯æŠ˜å æ ‡é¢˜æ 
* SliverPersistentHeaderï¼šæŒä¹…åŒ–å¤´éƒ¨
* è¿˜æœ‰å¾ˆå¤šSliverï¼Œæ¯”å¦‚ `SliverPadding`

## SingleChildScrollView
`SingleChildScrollView`æ²¡æœ‰ä½¿ç”¨Sliverä½“ç³»ï¼Œä»ç„¶æ˜¯ä½¿ç”¨Boxå¸ƒå±€ï¼Œå®ƒé€‚ç”¨äºç®€å•çš„å•ä¸ªwidgetçš„æ»šåŠ¨åœºæ™¯ã€‚

## NestedScrollView
`NestedScrollView`å®ç°åŒå‘åµŒå¥—æ»‘åŠ¨çš„æ ¸å¿ƒåœ¨äºç»Ÿä¸€ç®¡ç†å†…å¤–å±‚æ»šåŠ¨çŠ¶æ€ï¼Œè€Œ`_NestedScrollCoordinator`æ­£æ˜¯è¿™ä¸€åè°ƒæœºåˆ¶çš„æ ¸å¿ƒå®ç°ç±»ã€‚å…¶æ ¸å¿ƒé€»è¾‘åŒ…æ‹¬ï¼š
1. åŒæ»šåŠ¨æ§åˆ¶å™¨è”åŠ¨
`_NestedScrollCoordinator`ç»´æŠ¤äº†ä¸¤ä¸ªæ»šåŠ¨æ§åˆ¶å™¨ï¼š
* `_outerController`ï¼šæ§åˆ¶å¤–å±‚æ»šåŠ¨è§†å›¾ï¼ˆç”±headerSliverBuilderæ„å»ºçš„å¤´éƒ¨åŒºåŸŸï¼Œå¦‚SliverAppBarï¼‰ã€‚
* `_innerController`ï¼šæ§åˆ¶å†…å±‚æ»šåŠ¨è§†å›¾ï¼ˆbodyå±æ€§å®šä¹‰çš„å†…å®¹åŒºåŸŸï¼Œå¦‚TabBarViewä¸­çš„åˆ—è¡¨ï¼‰ã€‚
é€šè¿‡è¿™ä¸¤ä¸ªæ§åˆ¶å™¨ï¼Œ`_NestedScrollCoordinator`å°†å†…å¤–å±‚æ»šåŠ¨ä½ç½®â€œç»‘å®šâ€ï¼Œä½¿å¾—ç”¨æˆ·æ“ä½œæ—¶ä¸¤è€…è¡¨ç°ä¸ºä¸€ä¸ªæ•´ä½“ã€‚
2. æ»šåŠ¨äº‹ä»¶åˆ†å‘ä¸å†²çªå¤„ç†
å½“ç”¨æˆ·æ»‘åŠ¨æ—¶ï¼Œ`_NestedScrollCoordinator`ä¼šæ ¹æ®å½“å‰æ»šåŠ¨çŠ¶æ€ï¼ˆå¦‚å†…å¤–å±‚æ˜¯å¦å¯æ»šåŠ¨ã€æ»šåŠ¨æ–¹å‘ç­‰ï¼‰å†³å®šå¦‚ä½•åˆ†é…æ»šåŠ¨äº‹ä»¶ï¼š
* å¤–å±‚ä¼˜å…ˆï¼šè‹¥å¤–å±‚æ»šåŠ¨è§†å›¾ï¼ˆå¦‚SliverAppBarï¼‰æœªæ»šåŠ¨åˆ°æœ€å¤§èŒƒå›´ï¼ˆä¾‹å¦‚AppBaræœªå®Œå…¨æ”¶èµ·ï¼‰ï¼Œæ»‘åŠ¨äº‹ä»¶ä¼˜å…ˆç”±å¤–å±‚å¤„ç†ã€‚
* å†…å±‚æ¥ç®¡ï¼šå½“å¤–å±‚æ»šåŠ¨åˆ°æé™ï¼ˆå¦‚AppBarå®Œå…¨æ”¶èµ·ï¼‰ï¼Œæ»‘åŠ¨äº‹ä»¶è‡ªåŠ¨ä¼ é€’ç»™å†…å±‚æ»šåŠ¨è§†å›¾ã€‚
* åå‘è”åŠ¨ï¼šå½“å†…å±‚æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶ï¼Œç»§ç»­å‘ä¸‹æ»‘åŠ¨ä¼šè§¦å‘å¤–å±‚æ»šåŠ¨ï¼ˆå¦‚AppBarå±•å¼€ï¼‰ã€‚

æ»šåŠ¨äº‹ä»¶å¤„ç†çš„å…³é”®ä»£ç ä½äº`_NestedScrollCoordinator`çš„`applyUserOffset`æ–¹æ³•ä¸­ã€‚


# PrimaryScrollController
ç§»åŠ¨ç«¯ä¼šé»˜è®¤ä½¿ç”¨ `PrimaryScrollController`ã€‚

> å¤šä¸ª scrollview ä½¿ç”¨åŒä¸€ä¸ª ScrollController æ—¶ï¼Œæ‰‹æŒ‡æ»‘åŠ¨ä¸ä¼šç›¸äº’å½±å“ï¼Œå› ä¸ºè§¦æ‘¸äº‹ä»¶æ˜¯ç›´æ¥æ§åˆ¶ scrollable é‡Œé¢çš„ positionï¼Œå¹¶æ²¡æœ‰é€šè¿‡ ScrollController æ‰§è¡Œã€‚è€Œå‡å¦‚ä½¿ç”¨ ScrollController çš„ jump() æ–¹æ³•æ‰§è¡Œæ»‘åŠ¨ï¼Œå°±ä¼šåŒæ—¶å½±å“å¤šä¸ªä½¿ç”¨å®ƒçš„ scrollviewã€‚

# ScrollNotification
`ScrollNotification`ç”¨äºå‘å‡ºæ»šåŠ¨äº‹ä»¶ï¼Œå®ƒæœ‰å¤šä¸ªå®ç°å­ç±»ï¼š
* `ScrollStartNotification`ï¼šå¼€å§‹æ»šåŠ¨
* `ScrollUpdateNotification`ï¼šæ»šåŠ¨ä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œåœ¨æ»šåŠ¨è¿‡ç¨‹ä¸­æŒç»­è§¦å‘
* `UserScrollNotification`ï¼šæ»šåŠ¨æ–¹å‘æ”¹å˜æˆ–åœæ­¢æ»šåŠ¨ï¼Œidle è¡¨ç¤ºåœæ­¢ï¼Œforward/reverse è¡¨ç¤ºå…·ä½“æ–¹å‘
* `ScrollEndNotification`ï¼šæ»šåŠ¨åœæ­¢
* `OverscrollNotification`ï¼šæ»šåŠ¨è¶…å‡ºè¾¹ç•Œ

`ScrollPosition`å†…éƒ¨åœ¨å„ä¸ªæ»šåŠ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šå‘å‡ºå¯¹åº”çš„`ScrollNotification`ã€‚