å†…å®¹æ¦‚è¦ï¼š
1. ä»‹ç»å…ƒç¼–ç¨‹
2. å¼€å‘ä¸€ä¸ªåŸºæœ¬çš„KSP
3. ä»‹ç»KSPçš„ä¸€äº›é‡è¦çš„ä½¿ç”¨ç»†èŠ‚å’Œå·¥ä½œæ–¹å¼

# åŸºæœ¬ä»‹ç»
## å…ƒç¼–ç¨‹
åœ¨æˆ‘ä»¬ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œå¦‚æœè¯¥åœºæ™¯å­˜åœ¨å¤§é‡çš„æ¨¡æ¿ã€é‡å¤ä»£ç ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›å¯ä»¥è‡ªåŠ¨ç”Ÿæˆè¿™äº›æ¨¡æ¿ä»£ç ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ç¼–å†™ï¼Œå…¶å®è¿™æ ·çš„æ¦‚å¿µå°±å¯ä»¥ç§°ä¸ºâ€œå…ƒç¼–ç¨‹â€ï¼ˆMetaprogrammingï¼‰ã€‚æŸ¥é˜…â€œå…ƒç¼–ç¨‹â€çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ ·çš„æè¿°ï¼š**å…ƒç¼–ç¨‹æ˜¯æŒ‡æŸç±»è®¡ç®—æœºç¨‹åºçš„ç¼–å†™ï¼Œè¿™ç±»è®¡ç®—æœºç¨‹åºç¼–å†™æˆ–è€…æ“çºµå…¶ä»–ç¨‹åºï¼ˆæˆ–è€…è‡ªèº«ï¼‰ä½œä¸ºå®ƒä»¬çš„æ•°æ®ï¼Œæˆ–è€…åœ¨è¿è¡Œæ—¶å®Œæˆéƒ¨åˆ†æœ¬åº”åœ¨ç¼–è¯‘æ—¶å®Œæˆçš„å·¥ä½œ**ã€‚è¿™æ˜¯ä¸€æ®µæ¯”è¾ƒæ‹—å£çš„å®šä¹‰ï¼Œç”¨æˆ‘è‡ªå·±çš„è¯æ¥é€šä¿—ã€ä¸ä¸¥è°¨åœ°æè¿°â€œå…ƒç¼–ç¨‹â€ï¼Œ**å…ƒç¼–ç¨‹å°±æ˜¯ä½¿ç”¨ç¼–å†™çš„ç¨‹åºæ¥ç¼–å†™ç¨‹åº**ã€‚

å…ƒç¼–ç¨‹æ ¹æ®æ‰§è¡Œçš„æ—¶æœºå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š
1. è¿è¡Œæ—¶å…ƒç¼–ç¨‹ï¼šä¾‹å¦‚å„ä¸ªç¼–ç¨‹è¯­è¨€çš„åå°„ã€Javaçš„åŠ¨æ€ä»£ç†ã€Groovy invokeMissingMethod
2. ç¼–è¯‘æ—¶å…ƒç¼–ç¨‹ï¼šä¾‹å¦‚Cè¯­è¨€çš„å®ã€C++æ¨¡æ¿ã€Java APTï¼ˆAnnotation Process Toolï¼‰

è¿è¡Œæ—¶ç¼–ç¨‹å¯ä»¥åœ¨è¿è¡Œæ—¶è§£æç¨‹åºè‡ªèº«ä¿¡æ¯å¹¶æ ¹æ®è¿™äº›ä¿¡æ¯ä¿®æ”¹ç¨‹åºè¡Œä¸ºï¼Œç¼–è¯‘æ—¶å…ƒç¼–ç¨‹åˆ™å¯ä»¥åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆæˆ–ä¿®æ”¹ä»£ç ã€‚å¹¿ä¹‰åœ°çœ‹ï¼Œæ‰‹åŠ¨æ‹¼æ¥ä»£ç ã€ä½¿ç”¨æ¨¡æ¿å¼•æ“ç”Ÿæˆä»£ç ç­‰æ–¹å¼éƒ½å¯ä»¥è®¤ä¸ºæ˜¯å…ƒç¼–ç¨‹ã€‚

å…ƒç¼–ç¨‹é™¤äº†å¯ä»¥å‡å°‘æ¨¡æ¿ä»£ç ã€é‡å¤ä»£ç ï¼Œè¿˜å¯ä»¥åˆ©ç”¨å…ƒç¼–ç¨‹æä¾›æ³¨è§£è¯­æ³•ç³–ã€å±è”½å…·ä½“å®ç°ï¼Œæ¯”å¦‚Retorfitã€Kotlin Composeã€‚

Androidåœºæ™¯çš„å…ƒç¼–ç¨‹
APTå’ŒKAPT
åœ¨æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„Androidå¹³å°ï¼Œå¦‚æœæ˜¯Javaè¯­è¨€ï¼Œè¿è¡Œæ—¶å…ƒç¼–ç¨‹å¯ä»¥ä½¿ç”¨Javaçš„åå°„ï¼Œç¼–è¯‘æ—¶å¯ä»¥ä½¿ç”¨Javaçš„APTç”Ÿæˆä»£ç ã€‚ï¼ˆå¦‚æœæ²¡æœ‰å¼€å‘è¿‡Java APTä¹Ÿæ²¡æœ‰å…³ç³»ï¼ŒKSPçš„ç”¨æ³•å’ŒJava APTç±»ä¼¼ï¼Œå­¦ä¼šKSPå¼€å‘ä¹Ÿå¯ä»¥å¿«é€Ÿä¸Šæ‰‹å¼€å‘APTï¼‰

å¦‚æœä½¿ç”¨Kotlinè¯­è¨€ï¼Œè¿è¡Œæ—¶Kotlinä¹Ÿå¯ä»¥ä½¿ç”¨åå°„ï¼Œè€Œåœ¨ç¼–è¯‘æ—¶å…ƒç¼–ç¨‹åœºæ™¯ä¸‹ï¼Œå› ä¸ºJava APTæ˜¯Javaè¯­è¨€è‡ªå·±çš„å·¥å…·ï¼Œå¹¶ä¸èƒ½å¤„ç†Kotlinä»£ç ï¼Œæ‰€ä»¥Kotlinå®˜æ–¹å¦å¤–åšäº†kaptæ¥æ”¯æŒKotliné—´æ¥ä½¿ç”¨Java APTï¼š
![kaptåŸç†å›¾](./å¼•ç”¨å›¾ç‰‡/kaptåŸç†.png)
kaptä¼šæŠŠKotlinæºç è½¬ä¸ºJavaä»£ç ï¼Œä»è€Œå¤ç”¨Javaçš„APTæœºåˆ¶ã€‚

kaptä¼šæŠŠkotlinæºç å¯¹åº”ç”Ÿæˆçš„Javaæºç æ”¾åˆ°æ¯ä¸ªæ¨¡å—çš„ build/tmp/kapt3/stubs ç›®å½•ä¸­ï¼Œå› ä¸ºAPTå¹¶ä¸ä¼šè§£æè¡¨è¾¾å¼è¯­å¥çº§åˆ«çš„ä»£ç ï¼Œæ‰€ä»¥åªéœ€è¦ç”Ÿæˆç©ºæ–¹æ³•ã€ç©ºå±æ€§å³å¯ã€‚

## KSP
ç”±äºkaptåªæ˜¯Java aptçš„å…¼å®¹è¿‡æ¸¡åšæ³•ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨ä»¥ä¸‹ä¸»è¦é—®é¢˜ï¼š
- æ‰§è¡Œæ•ˆç‡ä½ï¼šå…ˆæŠŠKotlinè½¬ä¸ºJavaä»£ç ï¼Œå¯¼è‡´æ‰§è¡Œé€Ÿåº¦æ…¢
- å¯¹Kotlinè¯­æ³•ç‰¹æ€§çš„æ”¯æŒä¸å‹å¥½ï¼šJava APTä½œä¸ºJavaè¯­è¨€è‡ªå·±çš„å·¥å…·ï¼Œå¯¹Kotlinè¯­è¨€ç‰¹æ€§å¹¶æ²¡æœ‰ä¸“é—¨çš„æ”¯æŒï¼Œæ‰€ä»¥ä¾‹å¦‚Kotlinçš„data classã€æ‰©å±•å‡½æ•°ã€varã€valè¿™äº›è¯­æ³•ç‰¹æ€§éƒ½ä¸ä¾¿è§£æã€‚ï¼ˆKotlinä½¿ç”¨@MetaDataæ³¨è§£ç»“åˆkapt_metadataæ–‡ä»¶çš„æ–¹å¼å®ç°äº†åœ¨Javaä»£ç ä¸­ä¿ç•™Kotlinè¯­æ³•ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨Kotlinçš„metadataåº“æ¥è§£æï¼‰

Googleå¼€å‘äº†KSPï¼ˆKotlin Symbol Processingï¼‰ç”¨äºæ›¿ä»£kaptã€‚KSPä½œä¸ºKotlinè‡ªå·±çš„ç¼–è¯‘æ—¶å…ƒç¼–ç¨‹å·¥å…·ï¼Œå¯ä»¥æ›´å¥½åœ°æ”¯æŒKotlinè¯­æ³•ç‰¹æ€§ï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚

KSPå¯ä»¥ç”¨äºåœ¨ç¼–è¯‘æ—¶è§£æç°æœ‰çš„Kotlin/Javaæºç ä¿¡æ¯å¹¶ç”Ÿæˆæ–°çš„ä»£ç ï¼Œä¾‹å¦‚Moshiå°±ç”¨å®ƒæ¥ç”ŸæˆJsonAdapteræ¨¡ç‰ˆä»£ç ï¼Œä»è€Œå‡å°‘åå°„ï¼Œæå‡æ‰§è¡Œæ•ˆç‡ã€‚

KSPçš„è®¾è®¡åŸåˆ™ï¼š
- æ”¯æŒKotlinè¯­æ³•ç‰¹æ€§
- æ”¯æŒJVM/Androidã€JSã€Nativeå¤šå¹³å°
- æ”¯æŒå¢é‡ç¼–è¯‘
- æ”¯æŒJava

KSPä¸æ”¯æŒçš„æ–¹é¢ï¼š
- ä¸èƒ½ä¿®æ”¹åŸæœ‰çš„ä»£ç 
- æ²¡æœ‰è¯­å¥çº§åˆ«å†…çœï¼Œä¸èƒ½è§£æè¯­å¥ã€è¡¨è¾¾å¼ä¿¡æ¯ã€‚ç®€å•åœ°è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬åªèƒ½é€šè¿‡KSPçŸ¥é“æŸä¸ªç±»æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œä½†ä¸èƒ½çŸ¥é“è¯¥æ–¹æ³•å†…çš„ä»£ç å—ä¿¡æ¯ã€‚
APT/KAPTä¹Ÿä¸æ”¯æŒè¿™äº›

KSPå®˜æ–¹æ–‡æ¡£ï¼šhttps://kotlinlang.org/docs/ksp-overview.html
Kotlinå®˜æ–¹ä»‹ç»ï¼šhttps://www.youtube.com/watch?v=Si0r2_N0J88ï¼Œhttps://www.youtube.com/watch?v=bv-VyGM3HCY&pp=ygUKa290bGluIGtzcA%3D%3D

# KSPå¼€å‘æµç¨‹Demo
å‰é¢ç®€å•ä»‹ç»äº†KSPï¼Œæˆ‘ä»¬ç°åœ¨æ¥å¼€å‘ä¸€ä¸ªè‡ªå·±çš„KSPå¤„ç†å™¨Demoï¼Œç†è§£KSPçš„å¼€å‘æ–¹å¼ã€‚

ä»¥ä¸€ä¸ªç®€å•çš„Domoä¸ºä¾‹ï¼Œæˆ‘ä»¬æƒ³ç»™ç±»åŠ ä¸Šç‰¹å®šçš„æ³¨è§£ï¼Œå°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„å·¥å‚ç±»ä»£ç ã€‚è¿™ä¸ªDemoæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œåªæ˜¯ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­æ¥å±•ç¤ºå¦‚ä½•ä¸Šæ‰‹ã€‚è¾¾åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š
```
// åŸæœ¬çš„ä»£ç 
@TestFactory
class Foo {}


// ç”Ÿæˆçš„ä»£ç 
class FooFactory {
    fun createFoo(): Foo {
        return Foo()
    }
}
```

## 1. åˆ›å»ºGradleæ¨¡å—
// Gradleé¡¹ç›®æ–‡ä»¶ç›®å½•ç»“æ„
```
|-- ......  // å…¶ä»–æ¨¡å—å’Œæ–‡ä»¶
|-- lib-compiler  // kspæ¨¡å—ï¼Œç”¨äºç”Ÿæˆä»£ç 
|         |-- ......
|         |-- build.gradle  // kspæ¨¡å—çš„build.gradleæ–‡ä»¶
|-- lib-annotations // æ³¨è§£æ¨¡å—ï¼Œæä¾›@TestFactoryæ³¨è§£
|-- build.gradle  // root projectçš„build.gradleæ–‡ä»¶
```
å› ä¸ºæ³¨è§£è¦åœ¨KSPæ¨¡å—ä¸­ä½¿ç”¨ï¼Œä¹Ÿè¦åœ¨ä¾èµ–KSPæ¨¡å—çš„ä¸Šå±‚æ¨¡å—ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥æŠŠæ³¨è§£æ¨¡å—è®¾ç½®ä¸ºå•ç‹¬çš„æ¨¡å—ã€‚
![kspæ¨¡å—å±‚æ¬¡](./å¼•ç”¨å›¾ç‰‡/kspæ¨¡å—å±‚æ¬¡.png)

åœ¨Gradle root project çš„ build.gradle é…ç½®ï¼š
```
plugins {
    // å®é™…å°±æ˜¯ org.jetbrains.kotlin.jvm æ’ä»¶
    kotlin("jvm") version "1.9.0" apply false
}

buildscript {
    dependencies {
        // å³ org.jetbrains.kotlin:kotlin-gradle-pluginï¼Œ
        // å¦‚æœæˆ‘ä»¬åœ¨å®‰å“é¡¹ç›®ä¸­ï¼Œå®é™…å¯ä»¥ä¸ç”¨åŠ ä¸Šè¿™ä¸ªä¾èµ–ï¼Œå› ä¸ºå®‰å“
        // ä½¿ç”¨çš„org.jetbrains.kotlin.androidæ’ä»¶å·²ç»åŒ…å«äº†æ­¤æ’ä»¶ã€‚
        // å¦‚æœæ˜¯ç‹¬ç«‹é¡¹ç›®ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æ­¤æ’ä»¶
        classpath(kotlin("gradle-plugin", version = "1.9.0"))
    }
}
```
lib-annotationsæ¨¡å—ä¸­æä¾›æ³¨è§£ï¼š
```
@Target(AnnotationTarget.CLASS)
@Retention(AnnotationRetention.SOURCE)
annotation class TestFactory
```

ç„¶ååœ¨ç¼–å†™kspçš„lib-compileræ¨¡å—ä¸­ä½¿ç”¨æ’ä»¶å’Œç›¸å…³ä¾èµ–
```
plugins {
    kotlin("jvm")
}

// ç°åœ¨ä¸€èˆ¬åœ¨settings.gradleå°±ä¼šé…ç½®ï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥ä¸ç”¨åœ¨æ¨¡å—çš„build.gradleä¸­é…ç½®repositories
repositories {
    mavenCentral()
}

dependencies {
    // ä¾èµ–kspåº“ï¼Œæ‰å¯ä»¥ç¼–å†™kspä»£ç ï¼Œç‰ˆæœ¬æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©
    implementation("com.google.devtools.ksp:symbol-processing-api:1.9.21-1.0.15")
}
```

> æ³¨æ„ï¼škspæ¨¡å— ä¸èƒ½æ˜¯androidæ¨¡å—ï¼Œbuildä¼šæŠ¥é”™ï¼Œåªèƒ½æ˜¯ä¸€ä¸ªJvmæ¨¡å—ï¼ˆå¦‚æœæ”¯æŒå¤šå¹³å°å¯èƒ½éœ€è¦å¦å¤–é…ç½®ï¼‰

## 2. ç¼–å†™KSPå¤„ç†å™¨ä»£ç 
ä¾èµ–äº†`com.google.devtools.ksp:symbol-processing-api`åº“åï¼Œå°±å¯ä»¥ä½¿ç”¨KSPæä¾›çš„apiæ¥ç¼–å†™KSPå¤„ç†å™¨ä»£ç ã€‚

### KSPå¤„ç†å™¨å…¥å£
SymbolProcessorProvideræ˜¯KSPæä¾›çš„æ¥å£ï¼Œæ¯ä¸ªä½¿ç”¨KSPçš„æ¨¡å—éƒ½ä¼šåœ¨æ‰§è¡ŒKSPä»»åŠ¡æ—¶ï¼Œå…ˆåˆ°é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°æˆ‘ä»¬ç¼–å†™çš„SymbolProcessorProviderå®ç°ç±»ï¼Œç„¶åæ„é€ å®ä¾‹å¹¶è°ƒç”¨å®ƒçš„createå‡½æ•°ï¼Œå¾—åˆ°æˆ‘ä»¬ç¼–å†™çš„SymbolProcessorå®ç°ç±»å¯¹è±¡ï¼Œç„¶åè°ƒç”¨SymbolProcessoræ‰§è¡Œæ ¸å¿ƒé€»è¾‘ã€‚

KSPä¼šä½œä¸ºGradleçš„ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œï¼Œæ‰§è¡Œå¤§è‡´æµç¨‹å¦‚å›¾ï¼š
![kspä»»åŠ¡æµç¨‹](./å¼•ç”¨å›¾ç‰‡/kspä»»åŠ¡æµç¨‹.png)

#### å®ç° SymbolProcessorProvider å’Œ SymbolProcessor
é‚£ä¹ˆé¦–å…ˆç¼–å†™SymbolProcessorProviderå’ŒSymbolProcessorçš„å®ç°ç±»ï¼š
```
// demoä»£ç 

class MySymbolProcessorProvider : SymbolProcessorProvider {
    override fun create(environment: SymbolProcessorEnvironment): SymbolProcessor {
        // è¿”å› SymbolProcessor å®ç°ç±»å®ä¾‹
        return MySymbolProcessor(
            environment.codeGenerator,
            environment.logger
        )
    }
}

// SymbolProcessor å®ç°ç±»
class MySymbolProcessor(
    private val codeGenerator: CodeGenerator,
    private val kspLogger: KSPLogger,
) : SymbolProcessor {
    override fun process(resolver: Resolver): List<KSAnnotated> {
        // è¿™é‡Œæ˜¯KSPå¤„ç†å™¨çš„æ ¸å¿ƒé€»è¾‘ç¼–å†™ä½ç½®
        TODO("Not yet implemented")
    }

    override fun finish() {
        // æ‰§è¡Œç»“æŸæ—¶å›è°ƒï¼Œä¸éœ€è¦åˆ™å¯ä»¥ä¸é‡å†™
    }

    override fun onError() {
        // åœ¨ksp processæµç¨‹å¼‚å¸¸æ—¶å›è°ƒï¼Œæ¯”å¦‚æŠ›å‡ºäº†å¼‚å¸¸
        // æˆ–è€…ä½¿ç”¨äº†kspLogger.errorå’Œexceptionï¼Œä¸éœ€è¦åˆ™å¯ä»¥ä¸é‡å†™
    }
}
```
åœ¨createå‡½æ•°ä¸­å¯ä»¥é€šè¿‡SymbolProcessorEnvironmentå‚æ•°å¾—åˆ°ç¯å¢ƒç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚kotlinç‰ˆæœ¬ã€ç›®æ ‡å¹³å°ï¼ˆKSPæ”¯æŒjvmã€jsã€nativeå¤šå¹³å°ï¼‰ç­‰ä¿¡æ¯ï¼Œæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å…¶ä¸­éœ€è¦çš„æ¥ä½¿ç”¨ï¼Œå¹¶è¿”å›æˆ‘ä»¬ç¼–å†™çš„SymbolProcessorå®ç°ç±»å®ä¾‹ã€‚

æˆ‘ä»¬çš„Demoä¸­åªéœ€è¦ä½¿ç”¨CodeGeneratorå’ŒKSPLoggerï¼Œæ‰€ä»¥è¿™é‡ŒåªæŠŠSymbolProcessorEnvironmentçš„è¿™ä¸¤ä¸ªå¯¹è±¡ä¼ ç»™äº†MySymbolProcessoræ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬çš„å®é™…å¼€å‘ä¸­åˆ™æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©ã€‚


---

CodeGeneratorå¯ä»¥ç”¨äºç”Ÿæˆä»£ç ï¼Œå°†åœ¨SymbolProcessorçš„processæ–¹æ³•ä¸­ä½¿ç”¨ã€‚
KSPLoggerå¯ä»¥ç”¨äºåœ¨KSPæ‰§è¡ŒæœŸé—´æ‰“å°æ—¥å¿—ï¼ˆkspä¸­android.util.Logæ— æ³•ä½¿ç”¨ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨æ–­ç‚¹ï¼‰
```
interface KSPLogger {

    fun logging(message: String, symbol: KSNode? = null)
    fun info(message: String, symbol: KSNode? = null)
    fun warn(message: String, symbol: KSNode? = null)
    fun error(message: String, symbol: KSNode? = null)
    fun exception(e: Throwable)
}
```
æ³¨æ„ï¼šå®é™…éªŒè¯loggingå’Œinfoéƒ½æ²¡æœ‰æ•ˆæœï¼Œåªèƒ½ä½¿ç”¨warnã€errorå’Œexceptionï¼Œä»KSPLoggerå®ç°ç±»æºç ä¸­å¯è§ï¼Œè®¾ç½®äº†æ—¥å¿—ç­‰çº§ä¸ºWarnï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨warnåŠä»¥ä¸Šçº§åˆ«çš„æ—¥å¿—


---
#### é…ç½® resources/META-INF/services
KSPä¼šä½¿ç”¨ServiceLoaderæ¥æŸ¥æ‰¾SymbolProcessorProviderï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨resources/META-INF/services/ç›®å½•ä¸­é…ç½®com.google.devtools.ksp.processing.SymbolProcessorProvideræ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­å†™ä¸ŠMySymbolProcessorProviderçš„å…¨é™å®šåç§°ï¼š
```
// Demo ä¸­çš„å…¨é™å®šåç§°å¦‚ä¸‹ï¼š
com.example.lib.ksp.MySymbolProcessorProvider
```

### æ‰§è¡ŒKSPå¤„ç†å™¨
#### é€šè¿‡Resolverè·å–æºç ç»“æ„ä¿¡æ¯
KSPè·å–åˆ°æˆ‘ä»¬çš„SymbolProcessoråï¼Œå°†ä¼šè°ƒç”¨å®ƒçš„processæ–¹æ³•ã€‚
```
class MySymbolProcessor(
    private val codeGenerator: CodeGenerator,
    private val kspLogger: KSPLogger,
) : SymbolProcessor {
    override fun process(resolver: Resolver): List<KSAnnotated> {
        // TODO
    }
}
```
KSPå¯¹Kotlin/Javaæºç ç”Ÿæˆäº†å¯¹åº”çš„æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡processæ–¹æ³•çš„Resolverå‚æ•°è·å–åˆ°æºç æ–‡ä»¶å¯¹åº”çš„ç»“æ„ä¿¡æ¯ï¼Œæ¯”å¦‚KSFileè¡¨ç¤ºä¸€ä¸ªKotlin/Javaæ–‡ä»¶ï¼ŒKSClassDeclarationè¡¨ç¤ºä¸€ä¸ªKotlin/Javaç±»ï¼ŒResolverå¯ä»¥ç»™æˆ‘ä»¬æä¾›è¿™äº›ä¿¡æ¯ï¼š
```
KSFile
  packageName: KSName
  fileName: String
  annotations: List<KSAnnotation>  (File annotations)
  declarations: List<KSDeclaration>
    KSClassDeclaration // class, interface, object
      simpleName: KSName
      qualifiedName: KSName
      containingFile: String
      typeParameters: KSTypeParameter
      parentDeclaration: KSDeclaration
      classKind: ClassKind
      primaryConstructor: KSFunctionDeclaration
      superTypes: List<KSTypeReference>
      // contains inner classes, member functions, properties, etc.
      declarations: List<KSDeclaration>
    KSFunctionDeclaration // top level function
      simpleName: KSName
      qualifiedName: KSName
      containingFile: String
      typeParameters: KSTypeParameter
      parentDeclaration: KSDeclaration
      functionKind: FunctionKind
      extensionReceiver: KSTypeReference?
      returnType: KSTypeReference
      parameters: List<KSValueParameter>
      // contains local classes, local functions, local variables, etc.
      declarations: List<KSDeclaration>
    KSPropertyDeclaration // global variable
      simpleName: KSName
      qualifiedName: KSName
      containingFile: String
      typeParameters: KSTypeParameter
      parentDeclaration: KSDeclaration
      extensionReceiver: KSTypeReference?
      type: KSTypeReference
      getter: KSPropertyGetter
        returnType: KSTypeReference
      setter: KSPropertySetter
        parameter: KSValueParameter
```
è¿™ä¸ªç»“æ„æè¿°å¯ä»¥åœ¨[KSPè§’åº¦çš„æºç ç»“æ„å®˜æ–¹æ–‡æ¡£](https://kotlinlang.org/docs/ksp-overview.html#how-ksp-looks-at-source-files)ä¸­æŸ¥çœ‹ï¼Œå¹¶ä¸éœ€è¦è®°ä½ï¼Œä½¿ç”¨çš„æ—¶å€™æŸ¥çœ‹APIå³å¯ã€‚

#### ä½¿ç”¨CodeGeneratorç”Ÿæˆä»£ç 
æˆ‘ä»¬åœ¨processæ–¹æ³•ä¸­é€šè¿‡Resolveræ‰¾åˆ°æ‰€æœ‰ä½¿ç”¨äº† @TestFactory æ³¨è§£çš„ç±»ï¼Œä¸ºå®ƒä»¬ç”Ÿæˆå·¥å‚ç±»æ–‡ä»¶ï¼š
```
class MySymbolProcessor(
    private val codeGenerator: CodeGenerator,
    private val kspLogger: KSPLogger,
) : SymbolProcessor {
    override fun process(resolver: Resolver): List<KSAnnotated> {
        // getSymbolsWithAnnotationæ–¹æ³•å¯ä»¥è·å–æ ‡æ³¨äº†æŸä¸ªæ³¨è§£çš„Symbol
        val symbols = resolver.getSymbolsWithAnnotation(TestFactory::class.qualifiedName!!)
        symbols
            // è¿‡æ»¤å…¶ä¸­çš„ KSClassDeclarationã€‚å®šä¹‰TestFactoryæ³¨è§£æ—¶ï¼Œå°±è®¾ç½®äº†åªèƒ½ç”¨äºç±»ï¼Œ
            // æ‰€ä»¥è¿™é‡Œè¿‡æ»¤åªæ˜¯æ›´ä¿é™©ä¸€ç‚¹ã€‚
            .filter { it is KSClassDeclaration && it.validate() }
            // è½¬ä¸º KSClassDeclaration ç±»å‹
            .map { it as KSClassDeclaration }
            .forEach {
                // è·å–åŒ…å
                val packageName = it.packageName.asString()
                // ä½¿ç”¨äº† @TestFactory æ³¨è§£çš„ç±»å
                val originClassName = it.simpleName.asString()
                // è®¾ç½®ç”Ÿæˆçš„æ–‡ä»¶åï¼Œæ¯”å¦‚Fooå°±ä¼šç”ŸæˆFooFactory
                val fileName = "${originClassName}Factory"
                
                // åˆ›å»ºè¯¥æ–‡ä»¶
                val file = codeGenerator.createNewFile(
                    Dependencies(false, it.containingFile!!), // è¿™ä¸ªåé¢ä¼šå…·ä½“ä»‹ç»ï¼Œè¿™é‡Œå…ˆéšä¾¿å†™
                    packageName,
                    fileName
                )
                
                // æ–‡ä»¶çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯Kotlinä»£ç 
                val code = """
                    package $packageName
                    class ${originClassName}Factory {
                        fun create${originClassName}(): ${originClassName} {
                            return ${originClassName}()
                        }
                    }
                """.trimIndent()
                // å†™å…¥ç”Ÿæˆçš„æ–‡ä»¶
                file.write(code.toByteArray())
                file.close()
            }
        return emptyList()
    }
}
```
> Demoä¸­çœç•¥äº†é”™è¯¯æ£€æµ‹ï¼Œæ¯”å¦‚ä½¿ç”¨@TestFactoryæ³¨è§£çš„ç±»æ²¡æœ‰å…¬å¼€çš„æ— å‚æ„é€ å‡½æ•°ï¼Œå°±ä¼šå‘ç”Ÿé”™è¯¯ï¼Œåœ¨å®é™…å¼€å‘ä¸­éœ€è¦è€ƒè™‘å®Œå–„ã€‚

## 3. ä½¿ç”¨ç¼–å†™çš„KSP
æ¯”å¦‚æˆ‘ä»¬è¦åœ¨ app æ¨¡å—ä¸­ä½¿ç”¨å‰é¢ç¼–å†™çš„KSPï¼š
```
plugins {
    // ...... å…¶ä»–æ’ä»¶
    
    // éœ€è¦KSPæ’ä»¶ï¼Œæ‰èƒ½åœ¨å½“å‰æ¨¡å—ä¾èµ–å’Œæ‰§è¡ŒKSP
    id("com.google.devtools.ksp") version "1.9.21-1.0.15"
}

dependencies {
    // ä¾èµ–KSPæ¨¡å—
    ksp(project(":lib-compiler"))
    // ä¾èµ–æ³¨è§£
    implementation(project(":lib-annotations"))
    // ......
}
```
ç”Ÿæˆä»£ç ä¼šæ”¾åœ¨ build/generated/ksp/ ç›®å½•ä¸­

**è‡ª KSP 1.8.0-1.0.9 èµ·ï¼Œç”Ÿæˆçš„æºæ–‡ä»¶ä¼šè‡ªåŠ¨æ³¨å†Œï¼Œå¦‚æœç‰ˆæœ¬åä½ï¼Œåˆ™è¿˜éœ€è¦æ‰‹åŠ¨é…ç½®æ„ŸçŸ¥KSPç”Ÿæˆçš„æ–‡ä»¶**


---
åˆ°è¿™é‡Œå·²ç»å¼€å‘äº†ä¸€ä¸ªç®€å•çš„KSPï¼Œæ€»ç»“ä¸€ä¸‹å¼€å‘æµç¨‹ï¼š
1. é…ç½®æ’ä»¶å’Œä¾èµ–
2. ç¼–å†™SymbolProcessorProviderï¼Œå¹¶é…ç½®åˆ°resrouces/META-INF/services
3. ç¼–å†™SymbolProcessorï¼Œåœ¨processä½¿ç”¨Resovlerè·å–æºç ä¿¡æ¯ï¼Œä½¿ç”¨CodeGeneratorç”Ÿæˆä»£ç 
## 4. ç»“åˆå¸¸ç”¨å·¥å…·
å‰é¢ç”¨éå¸¸ç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºäº†å¼€å‘ä¸€ä¸ªKSPçš„æµç¨‹ï¼Œåœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œè¿˜æœ‰ä¸€äº›å¸¸ç”¨çš„å·¥å…·ç”¨æ¥æ›´æ–¹ä¾¿åœ°ç¼–å†™KSPã€‚
4.1 ä½¿ç”¨ AutoService
å‰é¢è¯´åˆ°KSPä½¿ç”¨ServiceProviderçš„æ–¹å¼ï¼Œéœ€è¦åœ¨ resources/META-INF/serivces ç›®å½•ä¸­å†™ä¸Šå¯¹åº”çš„æ–‡ä»¶å’Œç±»ä¿¡æ¯ã€‚å¯¹äºè¿™ç§åœºæ™¯ï¼ŒGoogleå¼€å‘çš„AutoServiceåº“å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œç¼–å†™Java APTçš„é¡¹ç›®å¾ˆå¤šéƒ½ä½¿ç”¨äº†å®ƒã€‚
https://github.com/google/auto/tree/main/service

ä½†AutoServiceæœ¬èº«ä¹Ÿæ˜¯ä½¿ç”¨äº†Java APTæ¥å®ç°çš„ï¼Œå¹¶ä¸æ”¯æŒKotlinï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªKSPç‰ˆæœ¬ï¼Œhttps://github.com/ZacSweers/auto-service-kspï¼Œæˆ‘ä»¬ä½¿ç”¨çš„Jsonåºåˆ—åŒ–åº“Moshiä¹Ÿä½¿ç”¨äº†å®ƒã€‚
```
plugins {
    // .......
    
    // å› ä¸ºè¦ç”¨åˆ°çš„ auto-service-ksp æœ¬èº«ä¹Ÿæ˜¯ä½¿ç”¨KSPå®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€å‘çš„KSPæ¨¡å—ä¹Ÿè¦ä½¿ç”¨KSPæ’ä»¶
    id("com.google.devtools.ksp") version "1.9.21-1.0.15"
}

dependencies {
    // ......
    
    implementation("com.google.auto.service:auto-service-annotations")
    ksp("dev.zacsweers.autoservice:auto-service-ksp")
}
```
```
package com.example

import com.google.auto.service.AutoService
import com.google.devtools.ksp.processing.SymbolProcessorProvider

@AutoService(SymbolProcessorProvider::class)
class TestSymbolProcessorProvider : SymbolProcessorProvider {
    override fun create(environment: SymbolProcessorEnvironment): SymbolProcessor {
        // ......
    }
}
```
resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvideræ–‡ä»¶å°†è‡ªåŠ¨ç”Ÿæˆï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```
// æ ¹æ®å®é™…ç±»çš„å…¨é™å®šåç§°è€Œå®š
com.example.MySymbolProcessorProvider
```

### 4.2 ä½¿ç”¨ KotlinPoet
Demoä¸­ç”Ÿæˆä»£ç ä½¿ç”¨çš„æ˜¯æ‰‹å†™æ‹¼æ¥çš„æ–¹å¼ï¼Œå¦‚æœç”Ÿæˆä»£ç çš„åœºæ™¯è¾ƒå¤æ‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨KotlinPoetæ¥ç”ŸæˆKotlinä»£ç ã€‚ï¼ˆä½¿ç”¨Java APTçš„æ—¶å€™æœ‰å¯¹åº”çš„JavaPoetï¼‰
https://square.github.io/kotlinpoet/
https://square.github.io/kotlinpoet/interop-ksp/
kotlinpoet-ksp åº“å¯ä»¥ä¸ºKotlinPoetåœ¨KSPåœºæ™¯æä¾›æ›´å¤šæ–¹ä¾¿çš„APIï¼Œå¯ä»¥ä¸€èµ·ä½¿ç”¨ã€‚

è¿™é‡Œæˆ‘ä»¬ç”¨KotlinPoetæ¥é‡å†™ç”Ÿæˆä»£ç çš„æµç¨‹ï¼š
```
class MySymbolProcessor(
    private val codeGenerator: CodeGenerator,
    private val kspLogger: KSPLogger,
) : SymbolProcessor {
    override fun process(resolver: Resolver): List<KSAnnotated> {
        // getSymbolsWithAnnotationæ–¹æ³•å¯ä»¥è·å–æ ‡æ³¨äº†æŸä¸ªæ³¨è§£çš„Symbol
        val symbols = resolver.getSymbolsWithAnnotation(TestFactory::class.qualifiedName!!)
        symbols
            .filter { it is KSClassDeclaration }
            .map { it as KSClassDeclaration }
            .forEach {
            
                // è·å–åŒ…å
                val packageName = it.packageName.asString()
                // è®¾ç½®ç”Ÿæˆçš„æ–‡ä»¶åï¼Œæ¯”å¦‚Fooå°±ä¼šç”ŸæˆFooFactory
                val fileName = "${it.simpleName.asString()}Factory"
                
                val funSpec = FunSpec.builder("create${it.simpleName.asString()}")
                    .returns(it.asType(emptyList()).toClassName())
                    .addStatement("return %T()", it.toClassName())
                    .build()

                val typeSpec = TypeSpec.classBuilder(fileName)
                    .addFunction(funSpec)
                    .build()

                val fileSpec = FileSpec.builder(packageName, fileName)
                    .addType(typeSpec)
                    .build()
                fileSpec.writeTo(codeGenerator, Dependencies.ALL_FILES)
            }
        return emptyList()
    }
}
```
ä½¿ç”¨KotlinPoetç›¸æ¯”ç¡¬ç¼–ç æ‹¼æ¥çš„æ–¹å¼ï¼Œå¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§æ›´é«˜ï¼Œåœ¨å¤æ‚åœºæ™¯æ›´åŠ æ˜æ˜¾ï¼Œå¹¶ä¸”è¿˜æœ‰è‡ªåŠ¨importç­‰ä¼˜ç‚¹ã€‚
è¿™é‡Œåªæ˜¯ä»‹ç»äº†éƒ¨åˆ†ç”¨æ³•ï¼ŒKotlinPoetæ›´è¯¦ç»†çš„åŠŸèƒ½å¯ä»¥é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œæ¯”è¾ƒç®€å•æ˜“æ‡‚ã€‚

# KSPå¼€å‘æ·±å…¥
å‰æ–‡ä»‹ç»äº†åŸºæœ¬çš„KSPå¤„ç†å™¨å¼€å‘è¿‡ç¨‹ï¼Œä½†å¿½ç•¥äº†ä¸€äº›ä½¿ç”¨ä¸Šçš„ç»†èŠ‚é—®é¢˜ï¼Œåœ¨è¿™é‡Œå°†ä»‹ç»å®ƒä»¬ï¼Œåˆ©äºæˆ‘ä»¬å†™å‡ºæ›´å¥½çš„KSPå·¥å…·ã€‚
## 1. processå¤šè½®æ‰§è¡Œå’Œè¿”å›å€¼
### å¤šè½®æ‰§è¡Œ
ä¸€ä¸ªæ¨¡å—æ‰§è¡Œ KSP ä»»åŠ¡ï¼ŒSymbolProcessorçš„processæ–¹æ³•å¯èƒ½ä¼šå¤šæ¬¡æ‰§è¡Œï¼Œè¢«æ‰§è¡Œå‡ æ¬¡ï¼Œå–å†³äºæˆ‘ä»¬æ˜¯å¦ç”Ÿæˆäº†æ–°çš„æ–‡ä»¶ã€‚å› ä¸ºæ–°ç”Ÿæˆçš„æ–‡ä»¶å¯èƒ½ä¹Ÿæ˜¯éœ€è¦å¤„ç†çš„ï¼Œæ‰€ä»¥KSPçš„è®¾è®¡æ˜¯å¤šè½®æ‰§è¡Œï¼ˆJava APTä¹Ÿæ˜¯è¿™æ ·ï¼‰ã€‚
![kspå¤šè½®æ‰§è¡Œ](./å¼•ç”¨å›¾ç‰‡/kspå¤šè½®æ‰§è¡Œ.png)
- é¦–æ¬¡æ‰§è¡Œprocessï¼Œæ²¡æœ‰ä½¿ç”¨CodeGeneratorç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼ˆç”Ÿæˆä»£ç æ–‡ä»¶æˆ–è€…resources/META-INF/servicesè¿™ç§é…ç½®æ–‡ä»¶éƒ½å¯ä»¥ï¼‰ï¼Œé‚£ä¹ˆæœ¬æ¨¡å—çš„KSPä»»åŠ¡å°†æ‰§è¡Œç»“æŸï¼Œprocessæ–¹æ³•ä¸å†è¢«è°ƒç”¨ã€‚
- é¦–æ¬¡æ‰§è¡Œprocessï¼Œä½¿ç”¨CodeGeneratorç”Ÿæˆäº†æ–°çš„æ–‡ä»¶ï¼Œprocessæ–¹æ³•å°†ä¼šå†è¢«æ¬¡æ‰§è¡Œï¼Œå› ä¸ºäº§ç”Ÿçš„æ–°æ–‡ä»¶å¯èƒ½ä¹Ÿéœ€è¦ç”¨äºè§£æå¤„ç†ï¼Œå†æ¬¡æ‰§è¡Œçš„processå¦‚æœä¹Ÿç”Ÿæˆäº†æ–°æ–‡ä»¶ï¼Œé‚£ä¹ˆåˆä¼šå†æ¬¡è°ƒç”¨processï¼Œç›´åˆ°æ²¡æœ‰æ–°çš„æ–‡ä»¶ç”Ÿæˆï¼Œæ‰ä¼šä¸å†è°ƒç”¨processã€‚

### processæ–¹æ³•è¿”å›å€¼
processæ–¹æ³•çš„è¿”å›å€¼ä¸ºList<KSAnnotated>ç±»å‹ï¼Œè¡¨ç¤ºæœ¬è½®æ— æ³•å¤„ç†çš„Symbolï¼Œåœ¨ä¸‹ä¸€è½®processæ‰§è¡Œæ—¶é€šè¿‡getSymbolsWithAnnotationå¯ä»¥è·å–åˆ°å®ƒä»¬ã€‚ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæœ¬è½®processæ²¡æœ‰ç”Ÿæˆæ–°çš„ä»£ç ï¼Œå°±ä¸ä¼šæ‰§è¡Œä¸‹ä¸€è½®ï¼Œé‚£ä¹ˆè¿”å›çš„listå³ä½¿ä¸æ˜¯ç©ºåˆ—è¡¨ä¹Ÿæ²¡æœ‰ä½œç”¨äº†ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ä¼šåœ¨æœ¬è½®processå¤„ç†å®Œï¼Œæ‰€ä»¥è¿”å›emptyListå°±è¡Œï¼Œé™¤éåœ¨æŸäº›æƒ…å†µï¼Œæœ¬è½®processä¸ä¾¿å¤„ç†ï¼Œéœ€è¦åœ¨ä¸‹ä¸€è½®processå†å¤„ç†ï¼Œé‚£å°±å¯ä»¥æŠŠè¯¥Symbolæ”¾åˆ°è¿”å›çš„Listä¸­ã€‚
ä¾‹å¦‚ï¼šç”ŸæˆæŸä¸ªä»£ç æ—¶ï¼Œéœ€è¦ä¾èµ–å…¶ä»–ç”Ÿæˆçš„ä»£ç ï¼Œå°±å¯ä»¥åœ¨æœ¬è½®processæ—¶å…ˆç”Ÿæˆå…¶ä»–ä»£ç ï¼ŒæŠŠæš‚ä¸å¤„ç†çš„Symbolæ”¾åˆ°Listä¸­è¿”å›ï¼Œåœ¨ä¸‹ä¸€è½®processæ—¶å·²ç»æœ‰äº†ä¹‹å‰ç”Ÿæˆçš„å…¶ä»–ä»£ç ï¼Œæ­¤æ—¶å°±å¯ä»¥å¤„ç†è¿™ä¸ªSymbolã€‚

> å¯ä»¥åœ¨ä»‹ç»Resolverçš„getSymbolsWithAnnotationæ–¹æ³•æ—¶ï¼Œä¸€èµ·åœ¨demoä»£ç ä¸­éªŒè¯

## 2. Resolver
äº†è§£äº†processæ–¹æ³•çš„æ‰§è¡Œæµç¨‹åï¼Œç»§ç»­äº†è§£processæ–¹æ³•æä¾›çš„Resolverçš„ç”¨æ³•ã€‚

Resolverå¯ä»¥æä¾›Kotlin/Javaæºç å’Œå®ƒä»¬è§£æåçš„æ¨¡å‹ä¿¡æ¯ï¼Œç”¨é€”å°±æ˜¯è®©æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†ææºç ä¿¡æ¯ï¼Œç”Ÿæˆæˆ‘ä»¬è‡ªå·±éœ€è¦çš„æ–‡ä»¶ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Resovlerçš„å„ä¸ªæ–¹æ³•çš„ç”¨é€”ã€‚
### æ ¸å¿ƒæ–¹æ³•
Resovleræœ‰3ä¸ªæœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œå¯ä»¥è·å–
#### 2.1.1 getNewFiles(): Sequence<KSFile>
getNewFiles()æ–¹æ³•å¯ä»¥è·å–å½“å‰ç¼–è¯‘æ¨¡å—ä¸­æœ¬è½®processçš„æ–°æºç æ–‡ä»¶ã€‚å¦‚æœæ˜¯ç¬¬ä¸€è½®processæ‰§è¡Œï¼Œåˆ™å®é™…å’ŒgetAllFiles()ä¸€æ ·è¿”å›å½“å‰æ¨¡å—çš„å…¨éƒ¨æºç æ–‡ä»¶ï¼Œå› ä¸ºç¬¬ä¸€è½®æ‰§è¡Œæ—¶å…¨éƒ¨ä»£ç æ–‡ä»¶éƒ½ç›¸å½“äºæ˜¯æ–°çš„ï¼›å¦‚æœç”Ÿæˆäº†æ–°çš„æºç æ–‡ä»¶ï¼Œå°†ç¬¬äºŒæ¬¡æ‰§è¡Œprocessï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œprocessæ—¶getNewFiles()è¿”å›çš„å°±æ˜¯ä¸Šä¸€æ¬¡ç”Ÿæˆçš„æ–°æºç æ–‡ä»¶ã€‚
![getNewFiles](./å¼•ç”¨å›¾ç‰‡/getNewFiles.png)
å¦‚æœåªå…³å¿ƒæ¯ä¸€è½®processæ–°äº§ç”Ÿçš„æ–‡ä»¶ï¼Œå°±å¯ä»¥ä½¿ç”¨getNewFiles()ã€‚

#### 2.1.2 getSymbolsWithAnnotation
åœ¨å‰é¢çš„Demoä¸­ï¼Œæˆ‘ä»¬å·²ç»ç”¨è¿‡äº†è¿™ä¸ªæ–¹æ³•ï¼Œé€šè¿‡å®ƒå¯ä»¥å¾—åˆ°ä½¿ç”¨äº†æŒ‡å®šæ³¨è§£çš„å…¨éƒ¨Symbolsï¼ˆæ¯”å¦‚ç±»ã€æ–¹æ³•ã€å±æ€§ç­‰ï¼‰ã€‚
```
fun getSymbolsWithAnnotation(
    annotationName: String,
    inDepth: Boolean = false
): Sequence<KSAnnotated>
```
getSymbolsWithAnnotationçš„ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œä½†æœ‰ä¸¤ä¸ªæ–¹é¢éœ€è¦äº†è§£ä¸€ä¸‹ï¼Œæ³¨è§£çš„æœç´¢èŒƒå›´å’ŒinDepthå‚æ•°çš„ä½œç”¨ã€‚
- æœç´¢èŒƒå›´
![getSymbolsWithAnnotationæœç´¢èŒƒå›´](./å¼•ç”¨å›¾ç‰‡/getSymbolsWithAnnotationæœç´¢èŒƒå›´.png)
æ¯ä¸€è½®processæ‰§è¡Œæ—¶ï¼ŒgetSymbolsWithAnnotationä¼šä»getNewFiles()çš„å…¨éƒ¨æºç æ–‡ä»¶å’Œä¸Šä¸€è½®processè¿”å›çš„List<KSAnnotated>ä¸­æŸ¥æ‰¾ä½¿ç”¨äº†æŒ‡å®šæ³¨è§£çš„Symbolsã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€è½®processï¼Œä¼šä»getNewFiles()ä¸­æŸ¥æ‰¾ä½¿ç”¨äº†æŒ‡å®šæ³¨è§£çš„Symbolsã€‚å¦‚æœç”Ÿæˆäº†æ–°æ–‡ä»¶ï¼Œå¹¶ä¸”processè¿”å›å€¼çš„Listä¸­åŒ…å«äº†ä¸€äº›Symbolsï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡æ‰§è¡Œprocessæ—¶ï¼ŒgetSymbolsWithAnnotationçš„æ³¨è§£æœç´¢èŒƒå›´å°±æ˜¯ç¬¬äºŒæ¬¡processçš„getNewFiles()+ç¬¬ä¸€æ¬¡processçš„è¿”å›Listã€‚å¦‚æœè¿˜æœ‰ä¸‹ä¸€æ¬¡processï¼Œä»¥æ­¤ç±»æ¨ã€‚

æ€»ç»“å°±æ˜¯ï¼š**æœç´¢èŒƒå›´ä¸ºæœ¬æ¬¡processçš„getNewFiles() + å‰ä¸€æ¬¡processçš„è¿”å›List<KSAnnotated>ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹processè¿”å›ä¸ºç©ºï¼Œé‚£ä¹ˆæœç´¢èŒƒå›´å°±æ˜¯ getNewFiles()ã€‚**

è¿˜æœ‰ä¸€ä¸ªæœç´¢æ–¹å¼çš„é—®é¢˜éœ€è¦æ³¨æ„ï¼Œä¾‹å¦‚æœ‰ä»¥ä¸‹æ–‡ä»¶A.ktï¼š
```
class A {
    @TestFun
    fun test() {}
}
```
åœ¨ç¬¬ä¸€æ¬¡processæ—¶ï¼ŒA.ktä½œä¸ºæ–°æ–‡ä»¶ï¼ŒgetSymbolsWithAnnotation(TestFun::class.qualifiedName)å¯ä»¥è·å–åˆ° test æ–¹æ³•å¯¹åº”çš„ KSFunctionDeclarationã€‚
å¦‚æœæœ¬æ¬¡processä¸æƒ³å¤„ç†è¿™ä¸ª KSFunctionDeclarationï¼Œå¯ä»¥æŠŠå®ƒæ”¾åˆ°processè¿”å›å€¼çš„Listä¸­ã€‚ä¸‹ä¸€æ¬¡processå†æ¬¡ä½¿ç”¨getSymbolsWithAnnotationå¯ä»¥è·å–åˆ°è¿™ä¸ª KSFunctionDeclarationã€‚
ä½†å¦‚æœæ”¾åˆ°processè¿”å›å€¼çš„Listä¸­çš„æ˜¯A.ktå¯¹åº”çš„KSFileæˆ–è€…Aç±»å¯¹åº”çš„KSClassDeclarationï¼Œåœ¨ä¸‹ä¸€æ¬¡processæ—¶è°ƒç”¨getSymbolsWithAnnotationå°†æ— æ³•è·å–åˆ°ä½¿ç”¨@TestFunæ³¨è§£çš„testæ–¹æ³•å¯¹åº”çš„ KSFunctionDeclarationã€‚

å› ä¸ºæœç´¢æ³¨è§£æ—¶ï¼Œå¦‚æœæ¥æºæ˜¯ getNewFiles()ï¼Œä¼šéå†å®ƒçš„å†…éƒ¨ç»“æ„ï¼ŒåŒ…å«ç±»ã€æ–¹æ³•ã€å±æ€§ç­‰ï¼›ä½†å¦‚æœæ¥æºæ˜¯ä¸Šä¸€è½®çš„è¿”å›å€¼List<KSAnnotated>æ—¶ï¼Œåªä¼šç›´æ¥æœç´¢å®ƒæœ¬èº«ï¼Œä¸ä¼šæœç´ å®ƒçš„åŒ…å«çš„å†…éƒ¨ç»“æ„ã€‚æ‰€ä»¥å¦‚æœè¿”å›å€¼ListåŒ…å«çš„æ˜¯KSClassDeclarationï¼Œå®ƒå†…éƒ¨çš„KSFunctionDeclarationæœ‰æŒ‡å®šçš„æ³¨è§£ä¹Ÿä¼šè¢«å¿½ç•¥ã€‚
è¿™ä¸ªæƒ…å†µåœ¨APIæ–‡æ¡£ä¸­æ²¡æœ‰è¯´æ¸…æ¥šï¼Œåœ¨æºç ä¸­å¯ä»¥çœ‹å‡ºæ¥ã€‚
https://github.com/google/ksp/blob/main/compiler-plugin/src/main/kotlin/com/google/devtools/ksp/processing/impl/ResolverImpl.kt#L321

- inDepth å‚æ•°
```
fun getSymbolsWithAnnotation(
    annotationName: String,
    inDepth: Boolean = false
): Sequence<KSAnnotated>
```
è¿™ä¸ªå‚æ•°æˆ‘ä»¬ä¸€èˆ¬ä¸æ€ä¹ˆä½¿ç”¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯è·å–å±€éƒ¨å£°æ˜çš„Symbolï¼Œæ¯”å¦‚Functionã€getterã€setterä¸­çš„å±€éƒ¨å£°æ˜ã€‚
ä¾‹å¦‚ä»¥ä¸‹æƒ…å†µï¼Œå¦‚æœinDepthä¸ºfalseï¼Œåˆ™ getSymbolsWithAnnotation(TestFun::class.qualifiedName!!) è¿”å›çš„å…¨éƒ¨Symbolä¸­ä¸ä¼šåŒ…å«è¿™ä¸ªå±€éƒ¨å‡½æ•°ã€‚è®¾ç½®ä¸ºtrueåˆ™å¯ä»¥è·å–åˆ°ã€‚
```
fun test() {
    @TestFun
    val a = fun() {}
}
```
æºç å¯è§æ­¤å¤„ï¼šhttps://github.com/google/ksp/blob/main/common-util/src/main/kotlin/com/google/devtools/ksp/common/visitor/CollectAnnotatedSymbolsVisitor.kt#L33

#### 2.1.3 getAllFiles(): Sequence<KSFile>
getAllFiles()ä¼šè¿”å›å½“å‰ç¼–è¯‘æ¨¡å—çš„å…¨éƒ¨æºç æ–‡ä»¶ï¼Œå¦‚æœæ–°ç”Ÿæˆäº†æºç æ–‡ä»¶ï¼Œåˆ™åœ¨ä¸‹ä¸€è½®processæ—¶ï¼Œä¼šè·å–åˆ°åŸæœ¬çš„æºç æ–‡ä»¶å’Œæ–°å¢çš„æºç æ–‡ä»¶ã€‚
![getAllFiles](./å¼•ç”¨å›¾ç‰‡/getAllFiles().png)

### å…¶ä»–æ–¹æ³•
å‰é¢ä»‹ç»äº†3ä¸ªæœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œè€ŒResovlerè¿˜æœ‰ä¸€äº›æ–¹æ³•ä½¿ç”¨åœºæ™¯åå°‘ä¸€ç‚¹ï¼Œå¯ä»¥ä½œä¸ºäº†è§£ã€‚

- getClassDeclarationByName(name: KSName): KSClassDeclaration?
æŸ¥æ‰¾ç¼–è¯‘classpathä¸­ï¼ŒæŒ‡å®šå…¨é™å®šåç§°å¯¹åº”çš„ç±»çš„KSClassDeclarationã€‚é‡è¦çš„æ˜¯ï¼Œå®ƒæŸ¥æ‰¾çš„èŒƒå›´ä¸é™äºå½“å‰æ¨¡å—ï¼Œä¹Ÿä¸é™äºæºç ï¼Œæ¯”å¦‚appæ¨¡å—ä¾èµ–libæ¨¡å—ï¼Œåœ¨appæ¨¡å—æ‰§è¡Œkspä»»åŠ¡æ—¶ï¼Œé€šè¿‡getClassDeclarationByNameå¯ä»¥æŸ¥æ‰¾åˆ°libæ¨¡å—å†…çš„ä»£ç ï¼ˆä½†libæ¨¡å—ä¸èƒ½æŸ¥æ‰¾åˆ°appæ¨¡å—çš„ç±»ï¼Œç”±ä¾èµ–å…³ç³»å†³å®šï¼‰ï¼Œå¹¶ä¸”å¯ä»¥æŸ¥æ‰¾åˆ°classæ–‡ä»¶ï¼Œæ¯”å¦‚å¯ä»¥æ‰¾åˆ°classæ–‡ä»¶android.app.Activityã€‚

åœ¨éœ€è¦æ”¯æŒè·¨æ¨¡å—æˆ–è€…æ”¯æŒæŸ¥æ‰¾Jarã€aarä¸­çš„äºŒè¿›åˆ¶ä»£ç æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ­¤æ–¹æ³•ã€‚è€ŒgetNewFiles()ã€getAllFiles()å’ŒgetSymbolsWithAnnotationåªèƒ½è·å–å½“å‰ç¼–è¯‘æ¨¡å—çš„æºç æ–‡ä»¶ã€‚

- getFunctionDeclarationsByNameã€getPropertyDeclarationByName 
å’ŒgetClassDeclarationByNameç±»ä¼¼ï¼Œåªæ˜¯è·å–çš„æ˜¯æ–¹æ³•å’Œå±æ€§ã€‚

- å‰©ä½™çš„æ–¹æ³•éƒ½æ˜¯ä¸€äº›ç‰¹å®šåœºæ™¯çš„å·¥å…·æ–¹æ³•ï¼Œåœ¨ä½¿ç”¨æ—¶æŸ¥çœ‹Resolver APIå³å¯ã€‚

## 3. å¢é‡å¤„ç†
å®˜æ–¹æ–‡æ¡£ï¼šhttps://kotlinlang.org/docs/ksp-incremental.html
KSPé»˜è®¤æ”¯æŒå¢é‡å¤„ç†ï¼Œå¯ä»¥å‡å°‘å¯¹ä»£ç æ–‡ä»¶çš„é‡å¤å¤„ç†ï¼Œæå‡æ‰§è¡Œæ•ˆç‡ï¼Œè¿™å¯¹å†™ä¸€ä¸ªå¥½çš„KSPå·¥å…·å¾ˆé‡è¦ã€‚å®˜æ–¹æ–‡æ¡£ä»‹ç»äº†å¢é‡å¤„ç†çš„ä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯ä¸å¤Ÿæ˜“æ‡‚å’Œè¯¦ç»†ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬æ›´è¯¦ç»†åœ°ä»‹ç»å¢é‡å¤„ç†çš„è§„åˆ™å’Œä½¿ç”¨æ–¹å¼ã€‚

å¢é‡å¤„ç†çš„ç›®çš„å°±æ˜¯å¦‚æœä¸€ä¸ªæ–‡ä»¶ä¸éœ€è¦å†æ¬¡å¤„ç†å°±ä¸å†å¤„ç†ï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­å“ªäº›æ–‡ä»¶éœ€è¦å¤„ç†ï¼Œå“ªäº›æ–‡ä»¶ä¸éœ€è¦å¤„ç†ã€‚æ¯”å¦‚ç¼–è¯‘ä»£ç æ—¶ï¼Œå¦‚æœä¸€ä¸ªä»£ç æ–‡ä»¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå°±ä¸ç”¨å†æ¬¡ç¼–è¯‘ã€‚

åœ¨KSPçš„æƒ…å†µä¸­ï¼Œä¼šä½¿ç”¨CodeGeneratorç”Ÿæˆä»£ç æˆ–å…¶ä»–æ–‡ä»¶ï¼Œåœ¨å‰é¢demoä»£ç ä¸­ï¼Œæˆ‘ä»¬å¿½ç•¥äº†Dependencieså‚æ•°çš„å…·ä½“ä½œç”¨ï¼Œè¿™ä¸ªDependenciesä¼šè¢«ç”¨äºå¢é‡å¤„ç†çš„åˆ¤æ–­ï¼Œå½±å“ç”Ÿæˆçš„ä»£ç æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆã€‚
```
fun createNewFile(
    dependencies: Dependencies,
    packageName: String,
    fileName: String,
    extensionName: String = "kt"
): OutputStream


class Dependencies private constructor(
    val isAllSources: Boolean, // æ˜¯å¦ä¾èµ–å…¨éƒ¨æºç ï¼Œåªè¦ä»»ä½•æºç å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šå®Œå…¨é‡æ–°æ‰§è¡ŒKSP
    val aggregating: Boolean, // 
    val originatingFiles: List<KSFile>
) {

    constructor(aggregating: Boolean, vararg sources: KSFile) : this(false, aggregating, sources.toList())

    companion object {
        val ALL_FILES = Dependencies(true, true, emptyList())
    }
}
```
æ ¹æ®Dependenciesçš„æ„é€ å‡½æ•°è®¾è®¡ï¼Œæœ‰ä¸‰ç§æ„é€ ç±»å‹ï¼š
1. ALL_FILESï¼šä¹Ÿå°±æ˜¯ Dependencies(true, true, emptyList())
2. aggregatingæ¨¡å¼ï¼šDependencies(false, true, ...) ï¼Œaggregatingå‚æ•°ä¸ºtrue
3. isolatingæ¨¡å¼ï¼šDependencies(false, false, ...)ï¼Œaggregatingå‚æ•°ä¸ºfalse

ä¸‹é¢å°†ä»‹ç»è¿™ä¸‰ç§æ¨¡å¼å¯¹å¢é‡å¤„ç†çš„å½±å“ã€‚
> é€šè¿‡åœ¨gradle.propertiesæ–‡ä»¶ä¸­é…ç½® ksp.incremental.log=true ï¼Œå¯ä»¥æ‰“å¼€KSPå¢é‡å¤„ç†çš„æ—¥å¿—ï¼Œæ”¾åœ¨ç›®å½•build/kspCaches/<source set>/logs/ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ—¥å¿—æ›´æ–¹ä¾¿åœ°äº†è§£KSPé‡æ–°å¤„ç†äº†å“ªäº›æ–‡ä»¶ã€‚

### 3.1 ALL_FILES
è¡¨ç¤ºç”Ÿæˆçš„æ–‡ä»¶ä¾èµ–å…¨éƒ¨æºç ï¼Œæ‰€ä»¥ä»»ä½•æºç å‘ç”Ÿå˜åŒ–ï¼Œéƒ½éœ€è¦é‡æ–°ç”Ÿæˆæ–‡ä»¶ï¼Œæ¯æ¬¡æ‰§è¡Œçš„è¾“å…¥éƒ½æ˜¯å½“å‰æ¨¡å—æ‰€æœ‰æºç ã€‚å®é™…ä¹Ÿå°±æ˜¯å…³é—­äº†å¢é‡å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚
![](./å¼•ç”¨å›¾ç‰‡/å¢é‡å¤„ç†all_files.png)
å¦‚å›¾ï¼Œé¦–æ¬¡æ‰§è¡ŒKSPä»»åŠ¡ï¼Œæºç Aã€Bã€Céƒ½ä¼šä½œä¸ºSymbolProcessorçš„è¾“å…¥ï¼Œæ‰€ä»¥éƒ½ä¼šæ ‡è®°dirtyï¼Œdirtyçš„æ–‡ä»¶éƒ½ä¼šä½œä¸ºSymbolProcessorçš„è¾“å…¥ï¼Œç”Ÿæˆæ–‡ä»¶æ—¶ä½¿ç”¨äº†Dependencies.ALL_FILESã€‚

ä¿®æ”¹Aæ–‡ä»¶ï¼Œå†æ¬¡æ‰§è¡ŒKSPä»»åŠ¡ï¼ŒAæ–‡ä»¶æ ‡è®°ä¸ºdirtyï¼Œå¹¶ä¸”å› ä¸ºç”Ÿæˆçš„æ–‡ä»¶ä¾èµ–äº†å…¨éƒ¨æ–‡ä»¶ï¼Œæ‰€ä»¥Bå’ŒCä¹Ÿè¦æ ‡è®°ä¸ºdirtyï¼ŒAã€Bã€Cæ–‡ä»¶å°±ä¼šå†æ¬¡ä½œä¸ºæ‰§è¡ŒKSPä»»åŠ¡æ—¶SymbolProcessorçš„è¾“å…¥ï¼Œå› ä¸ºç”Ÿæˆçš„æ–‡ä»¶ä¾èµ–çš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶ä¼šè¢«åˆ é™¤ï¼Œç„¶åæ ¹æ®æœ¬æ¬¡çš„æºç è¾“å…¥ï¼Œå†æ¬¡æ‰§è¡Œç”Ÿæˆä»£ç çš„æµç¨‹ã€‚

> ç”Ÿæˆçš„æ–‡ä»¶ä¾èµ–äº†Aï¼ŒAå‘ç”Ÿä¿®æ”¹ï¼Œæ‰€ä»¥ç”Ÿæˆçš„æ–‡ä»¶éœ€è¦é‡æ–°ç”Ÿæˆï¼Œè€Œç”Ÿæˆçš„æ–‡ä»¶åˆä¾èµ–äº†Bå’ŒCï¼Œé‡æ–°ç”Ÿæˆæ–‡ä»¶åŒæ—¶éœ€è¦Aã€Bã€Cï¼Œæ‰€ä»¥Bå’ŒCå¿…é¡»ä¹Ÿæ ‡è®°ä¸ºdirtyï¼Œä¸€èµ·ä½œä¸ºå†æ¬¡æ‰§è¡ŒKSPä»»åŠ¡çš„è¾“å…¥æ–‡ä»¶ã€‚
### 3.2 aggregating
å¢é‡å¤„ç†çš„èšåˆæ¨¡å¼ï¼Œè¡¨ç¤ºç”Ÿæˆçš„æ–‡ä»¶å…³å¿ƒå½“å‰æ¨¡å—çš„ä»»ä½•æ–‡ä»¶ä¿®æ”¹å’Œæ–°å¢ã€‚å¦‚æœæŸäº›æ–‡ä»¶å‘ç”Ÿä¿®æ”¹æˆ–è€…æ–°å¢äº†æ–‡ä»¶ï¼Œåªæœ‰ä¿®æ”¹/æ–°å¢çš„æ–‡ä»¶ä»¥åŠoriginatingFilesä¼šå†æ¬¡ä½œä¸ºKSPçš„è¾“å…¥ã€‚

ä¼ ç»™Dependenciesçš„originatingFileså‚æ•°ï¼Œè¡¨ç¤ºç”Ÿæˆçš„æ–‡ä»¶æ˜¯åŸºäºè¿™äº›originatingFilesç”Ÿæˆçš„ã€‚ä¸‹é¢æ¥çœ‹ä½¿ç”¨aggregatingçš„å…·ä½“è¡¨ç°ã€‚
![](./å¼•ç”¨å›¾ç‰‡/å¢é‡å¤„ç†aggregating.png)

ç¤ºæ„å›¾è¯´æ˜ï¼š
- ç®­å¤´è¿çº¿ï¼šè¡¨ç¤ºç”ŸæˆOutputæ–‡ä»¶æ—¶ï¼ŒoriginatingFilesä¸ºInputA.ktå’ŒInputB.ktã€‚
- ç›¸æ¯”ALL_FILESçš„ç¤ºæ„å›¾ï¼Œçœç•¥äº†SymbolProcessorã€‚åªè¦æ˜¯æ ‡è®°dirtyçš„æ–‡ä»¶éƒ½æ˜¯SymbolProcessorçš„è¾“å…¥ã€‚


é¦–æ¬¡æ‰§è¡ŒKSPæ—¶ï¼Œæ‰€æœ‰æºç éƒ½æ ‡è®°dirtyï¼Œç”Ÿæˆä»£ç ä½¿ç”¨ Dependencies(aggregating = true, InputA, InputB)

ä¿®æ”¹äº†Aï¼Œå†æ¬¡æ‰§è¡ŒKSPï¼ŒAæ ‡è®°ä¸ºdirtyï¼Œå› ä¸ºOutputæ–‡ä»¶ä¾èµ–äº†Aï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç”ŸæˆOutputï¼Œå¹¶ä¸”å› ä¸ºOutputä¹Ÿä¾èµ–äº†Bï¼Œæ‰€ä»¥Bä¹Ÿéœ€è¦æ ‡è®°ä¸ºdirtyã€‚æ‰€ä»¥æœ¬æ¬¡KSPä»»åŠ¡çš„åˆå§‹è¾“å…¥åªæœ‰Aå’ŒBï¼Œæ²¡æœ‰Cã€Dã€‚æ ¹æ®æœ¬æ¬¡è¾“å…¥é‡æ–°æ‰§è¡Œç”Ÿæˆä»£ç çš„æµç¨‹ã€‚

ä¿®æ”¹äº†Cï¼Œå†æ¬¡æ‰§è¡ŒKSPï¼ŒCæ ‡è®°ä¸ºdirtyï¼Œå› ä¸ºä½¿ç”¨äº†aggregatingæ¨¡å¼ï¼Œå³ä½¿ä¸æ˜¯originatingFilesçš„ä¿®æ”¹ï¼Œä¹Ÿéœ€è¦é‡æ–°ç”ŸæˆOutputï¼Œå¹¶ä¸”Outputä¾èµ–äº†Aå’ŒBï¼Œæ‰€ä»¥Aå’ŒBä¹Ÿéœ€è¦æ ‡è®°ä¸ºdirtyã€‚é‚£ä¹ˆæœ¬æ¬¡KSPä»»åŠ¡çš„åˆå§‹è¾“å…¥ä¸ºAã€Bã€Cã€‚æ ¹æ®æœ¬æ¬¡è¾“å…¥é‡æ–°æ‰§è¡Œç”Ÿæˆä»£ç çš„æµç¨‹ã€‚

> originatingFileså¦‚æœä¼ ç©ºï¼Œå†æ¬¡æ‰§è¡ŒKSPä»»åŠ¡æ—¶ï¼ŒKSPä¼šæŠŠä¹‹å‰ç”Ÿæˆçš„å¯¹åº”æ–‡ä»¶åˆ æ‰ï¼Œå¦‚æœä¿®æ”¹çš„æ–‡ä»¶ä¸æ˜¯å®é™…ä¾èµ–çš„æ–‡ä»¶ï¼Œå†æ¬¡æ‰§è¡ŒKSPçš„è¾“å…¥å°±åªæœ‰ä¿®æ”¹çš„æ–‡ä»¶ï¼Œè€Œä¸€èˆ¬æˆ‘ä»¬çš„ä»£ç é€»è¾‘éƒ½æ˜¯è¦è¯»å–åˆ°æŸä¸ªæ–‡ä»¶æ‰èƒ½ç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶ï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸ä¼šèµ°ç”Ÿæˆä»£ç çš„é€»è¾‘ï¼Œå¯¼è‡´é”™è¯¯ã€‚
originatingFileså¦‚æœä¹±è®¾ç½®å®é™…æ²¡æœ‰ä¾èµ–å…³ç³»çš„æ–‡ä»¶ï¼Œä¹Ÿä¼šå¯¼è‡´ä¿®æ”¹æ–‡ä»¶åå†æ¬¡æ‰§è¡ŒKSPä»»åŠ¡ï¼Œä¾èµ–çš„æ–‡ä»¶æ²¡æœ‰ä½œä¸ºè¾“å…¥ï¼Œä¹Ÿå°±æ²¡æœ‰é‡æ–°ç”Ÿæˆæ–‡ä»¶ï¼Œå¯¼è‡´é”™è¯¯ã€‚
æ‰€ä»¥åŠ¡å¿…åˆç†è®¾ç½®originatingFilesã€‚

**aggregatingæ¨¡å¼æ€»ç»“ï¼šä¿®æ”¹æˆ–è€…æ–°å¢æ–‡ä»¶ï¼Œå‘ç”Ÿå˜åŒ–çš„è¿™äº›æ–‡ä»¶å’ŒoriginatingFileséƒ½ä¼šæ ‡è®°ä¸ºdirtyï¼Œè®©KSPå¤„ç†ã€‚å…¶ä»–æ— å…³æºç åˆ™ä¸ä¼šå†å¤„ç†ã€‚**

### 3.3 isolating
å¢é‡æ¨¡å¼çš„éš”ç¦»æ¨¡å¼ï¼Œè¡¨ç¤ºç”Ÿæˆçš„æ–‡ä»¶åªå…³å¿ƒä¾èµ–çš„æ–‡ä»¶çš„ä¿®æ”¹ã€‚åªæœ‰originatingFilesæ–‡ä»¶æ ‡è®°ä¸ºdirtyï¼Œæ‰ä¼šé‡æ–°ç”Ÿæˆæ–‡ä»¶ã€‚
![](./å¼•ç”¨å›¾ç‰‡/å¢é‡å¤„ç†isolating.png)
é¦–æ¬¡æ‰§è¡ŒKSPæ—¶ï¼Œæ‰€æœ‰æºç éƒ½æ ‡è®°dirtyï¼Œç”Ÿæˆä»£ç ä½¿ç”¨ Dependencies(aggregating = false, InputA, InputB)

ä¿®æ”¹äº†Aï¼Œå†æ¬¡æ‰§è¡ŒKSPï¼ŒAæ ‡è®°ä¸ºdirtyï¼Œå› ä¸ºOutputæ–‡ä»¶ä¾èµ–äº†Aï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç”ŸæˆOutputï¼Œå¹¶ä¸”å› ä¸ºOutputä¹Ÿä¾èµ–äº†Bï¼Œæ‰€ä»¥Bä¹Ÿéœ€è¦æ ‡è®°ä¸ºdirtyã€‚æ‰€ä»¥æœ¬æ¬¡KSPä»»åŠ¡çš„åˆå§‹è¾“å…¥åªæœ‰Aå’ŒBï¼Œæ²¡æœ‰Cã€‚

ä¿®æ”¹äº†Cï¼Œå†æ¬¡æ‰§è¡ŒKSPï¼ŒCæ ‡è®°ä¸ºdirtyï¼Œå› ä¸ºä½¿ç”¨äº†isolatingæ¨¡å¼ï¼ŒoriginatingFilesä¸åŒ…å«Cï¼Œæ‰€ä»¥åªæœ‰Cæ–‡ä»¶æ ‡è®°ä¸ºdirtyï¼Œé‚£ä¹ˆæœ¬æ¬¡KSPä»»åŠ¡çš„åˆå§‹è¾“å…¥å°±åªæœ‰Cæ–‡ä»¶ã€‚æ‰€ä»¥Outputä¸ä¼šé‡æ–°ç”Ÿæˆã€‚

> å’Œaggregatingæ¨¡å¼ä¸€æ ·ï¼ŒoriginatingFilesä¹Ÿè¦åˆç†è®¾ç½®ã€‚

### 3.4 æ–°å¢æ–‡ä»¶
æ–°å¢æ–‡ä»¶å¿…ç„¶éœ€è¦å¤„ç†ï¼Œæ‰€ä»¥æ— è®ºDependeciesæ€ä¹ˆè®¾ç½®ï¼Œæ–°å¢çš„æ–‡ä»¶å¿…ç„¶ä¼šä½œä¸ºKSPä»»åŠ¡çš„åˆå§‹è¾“å…¥ã€‚
æ¢ä¸ªè§’åº¦æ¥çœ‹ï¼ŒDependeciesæ˜¯ç”¨æ¥å‘Šè¯‰KSPç”Ÿæˆçš„æ–‡ä»¶çš„ä¾èµ–æƒ…å†µï¼Œæ–°å¢çš„æ–‡ä»¶å’Œä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶å®Œå…¨æ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥å’ŒDependeciesæ€ä¹ˆè®¾ç½®æ²¡æœ‰å…³ç³»ã€‚

### ç»¼åˆåœºæ™¯
ç»™ç”Ÿæˆçš„æ–‡ä»¶è®¾ç½®Dependenciesï¼Œå¯ä»¥çœ‹å‡ºæ¥KSPçš„å¢é‡å¤„ç†æ˜¯é’ˆå¯¹å•ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªç”Ÿæˆçš„æ–‡ä»¶éƒ½å¯ä»¥è®¾ç½®è‡ªå·±çš„å¢é‡å¤„ç†æƒ…å†µã€‚å®ƒä»¬ä¼šç»¼åˆèµ·æ¥å½±å“KSPä»»åŠ¡çš„è¾“å…¥æ–‡ä»¶ã€‚

ä»¥ä¸‹å¯ä»¥çœ‹åˆ°ä¸€äº›ç»¼åˆåœºæ™¯çš„ä¾‹å­ï¼š
![](./å¼•ç”¨å›¾ç‰‡/å¢é‡å¤„ç†ç»¼åˆåœºæ™¯.png)

## 4. å¤šä¸ªProcessor
æ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥ä½¿ç”¨å¤šä¸ªKSPï¼Œæ¯æ¬¡å°±ä¼šæ‰§è¡Œå¤šä¸ª
```
dependencies {
    ksp("a")
    ksp("b")
    // ......
}
```
æˆ–è€…ä¸€ä¸ªKSPæ¨¡å—é‡Œé¢é…ç½®å¤šä¸ªSymbolProcessorProvider
```
// æ–‡ä»¶ï¼š/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider

com.xxx.A
com.xxx.B
```
![](./å¼•ç”¨å›¾ç‰‡/kspå¤šä¸ªprocessor.png)
æ¯ä¸€è½®éƒ½ä¼šè°ƒç”¨ä¾èµ–çš„æ‰€æœ‰KSPå¤„ç†å™¨ï¼Œæ‰€æœ‰å¤„ç†å™¨ç”Ÿæˆçš„ä»£ç ï¼Œéƒ½ä¼šä½œä¸ºä¸‹ä¸€è½®processçš„newFilesã€‚

# å…¶ä»–
## 1. è·¨æ¨¡å—çš„é™åˆ¶
å‡å¦‚æˆ‘ä»¬è¦å¼€å‘ä¸€ä¸ªå¯åŠ¨ä»»åŠ¡è°ƒåº¦åº“ï¼Œåœ¨ lib1ã€lib2 å’Œappæ¨¡å—éƒ½ä½¿ç”¨æ³¨è§£å£°æ˜å¯åŠ¨ä»»åŠ¡ï¼Œåœ¨appæ¨¡å—ä½¿ç”¨KSPç”Ÿæˆä»£ç æ—¶ï¼Œéœ€è¦æ”¶é›†åˆ°è‡ªèº«å’Œå…¨éƒ¨å­æ¨¡å—ä¸­æ³¨è§£å£°æ˜çš„å¯åŠ¨ä»»åŠ¡ï¼Œæ‰èƒ½æ‰§è¡Œå…¨éƒ¨å¯åŠ¨ä»»åŠ¡ã€‚
```
// InitTaskåº“ï¼šéœ€è¦å£°æ˜æ³¨è§£ @InitTask ã€æä¾›å¯èƒ½éœ€è¦çš„åŸºç¡€ä»£ç ã€æä¾›KSPã€‚

// lib1 æ¨¡å—
@InitTask
class Task1: Runnable {}

// lib2 æ¨¡å—
@InitTask
class Task2: Runnable  {}

// app æ¨¡å—
@InitTask
class Task3: Runnable  {}

// ç”Ÿæˆä»£ç ï¼Œåœ¨Applicationä¸­è°ƒç”¨ TaskContainer.init() æ‰§è¡Œ
objec TaskContainer {
    fun init() {
        Task1().run()
        Task2().run()
        Task3().run()
    }
}
```
![](./å¼•ç”¨å›¾ç‰‡/kspè·¨æ¨¡å—demoå±‚æ¬¡.png)
æ¯ä¸ªæ¨¡å—æ‰§è¡ŒKSPä»»åŠ¡æ—¶ï¼ŒgetNewFiles ã€getSymbolsWithAnnotationå’ŒgetAllFilesè¿™ä¸‰ä¸ªæ–¹æ³•è¯»å–çš„ä»£ç éƒ½æ˜¯ä»…è·å–å½“å‰æ¨¡å—å†…çš„æºç ã€‚é‚£ä¹ˆåœ¨appæ¨¡å—æ‰§è¡ŒKSPä»»åŠ¡æ—¶ï¼Œå¦‚ä½•æ”¶é›†åˆ°å­æ¨¡å—å£°æ˜çš„å¯åŠ¨ä»»åŠ¡å‘¢ï¼Ÿ

Resolveræä¾›çš„getClassDeclarationByNameã€getDeclarationsFromPackageè¿™ç±»æ–¹æ³•è™½ç„¶å¯ä»¥è·å–åˆ°å­æ¨¡å—ä¸­çš„ä»£ç ä¿¡æ¯ï¼Œä½†éƒ½å¿…é¡»æŒ‡å®šåŒ…åæˆ–ç±»åï¼Œè€Œä¸èƒ½åƒgetNewFileså’ŒgetSymbolsWithAnnotationä¸€æ ·å¯ä»¥éå†æœç´¢ã€‚

æ‰€ä»¥ä»…ä½¿ç”¨KSPæƒ³è¦åšåˆ°æœç´¢å…¶ä»–æ¨¡å—çš„ä»£ç æ–‡ä»¶ï¼Œåªèƒ½åšä¸€äº›é¢å¤–çš„çº¦æŸï¼Œæ¯”å¦‚çº¦å®šä»£ç éƒ½æ”¾åˆ°æŸä¸ªç‰¹å®šåŒ…åå†…ã€‚

### ä¸€äº›è·¨æ¨¡å—æ¡ˆä¾‹
1. ARouterï¼šARouterä½œä¸ºä¸€ä¸ªç”¨äºç»„ä»¶åŒ–åœºæ™¯çš„è·¯ç”±åº“ï¼Œä¹Ÿæ˜¯éœ€è¦æ”¶é›†å„ä¸ªæ¨¡å—çš„é…ç½®ä¿¡æ¯ï¼Œè™½ç„¶ARouterä½¿ç”¨çš„APTï¼Œå¹¶ä¸æ˜¯KSPï¼Œä½†æ˜¯åšæ³•æ˜¯å¯ä»¥å€Ÿé‰´çš„ã€‚å®ƒçš„è€ç‰ˆæœ¬åšæ³•æ˜¯åœ¨Appå¯åŠ¨æ—¶ä½¿ç”¨è§£æDexçš„æ–¹å¼å»è·å–å…¨éƒ¨æ¨¡å—çš„ç”Ÿæˆç±»ï¼Œåæ¥çš„ç‰ˆæœ¬åšäº†gradleæ’ä»¶ï¼Œåˆ©ç”¨Android Gradle Plugin Transformæ¥éå†å…¨éƒ¨classæ–‡ä»¶æ“ä½œå­—èŠ‚ç ã€‚
2. EventBusï¼šEventBusä¹Ÿéœ€è¦æ”¶é›†å¤šä¸ªæ¨¡å—çš„é…ç½®ï¼Œå®ƒçš„åšæ³•æ˜¯è¦æ±‚ç”¨æˆ·åœ¨æ¯ä¸ªæ¨¡å—æ‰‹åŠ¨æŠŠç”Ÿæˆçš„ä»£ç æ³¨å…¥åˆ°ä¸€ä¸ªå…¨å±€å…¬å…±ç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯æ‰‹åŠ¨å®Œæˆè¿™ä¸ªæ“ä½œã€‚

æ€»çš„æ¥è¯´ï¼ŒAPTã€KAPTã€KSPè¿™ç±»å·¥å…·åœ¨è·¨æ¨¡å—æ—¶ï¼Œéƒ½ä¼šæœ‰ä¸ä¾¿éå†å…¶ä»–æ¨¡å—çš„ç›¸å…³ä¿¡æ¯çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘é€šè¿‡ç‰¹å®šçš„çº¦æŸã€æ‰‹åŠ¨æ³¨å†Œã€AGP Transformæ’ä»¶ä¿®æ”¹å­—èŠ‚ç ã€åå°„ç­‰æ–¹å¼æ¥é…åˆå®Œæˆã€‚
> Java APTåªèƒ½è·å–å½“å‰æ¨¡å—çš„ä»£ç ä¿¡æ¯ï¼Œæ¯”KSPçš„é™åˆ¶æ›´å¤§ï¼Œæ‰€ä»¥å¾ˆå¤šåŒæ—¶æ”¯æŒAPT/KAPTå’ŒKSPçš„åº“ï¼Œåœ¨éœ€è¦è·¨æ¨¡å—è®¿é—®ä»£ç çš„æƒ…å†µéƒ½åªèƒ½ä¾é æ‰‹åŠ¨æ³¨å†Œæˆ–è€…AGPæ’ä»¶æ“ä½œå­—èŠ‚ç è¿™äº›æ–¹å¼ã€‚

## 2. ä¸ä¸€å®šè¦ç”¨æ³¨è§£
Java APTçš„è®¾è®¡æ˜¯ä»¥æ³¨è§£ä¸ºæ ¸å¿ƒï¼Œå®ƒçš„APIéƒ½æ˜¯å›´ç»•æ³¨è§£è®¾è®¡çš„ï¼ˆä½†ä¹Ÿå¯ä»¥ä¸é æ³¨è§£æ¥ç”Ÿæˆä»£ç ï¼‰ã€‚è€ŒKSPçš„è®¾è®¡å¹¶æ²¡æœ‰å¤ªå‡¸æ˜¾æ³¨è§£çš„æ ¸å¿ƒåœ°ä½ï¼Œåªä¸è¿‡ä¸€èˆ¬æ¥è¯´è¿˜æ˜¯æ¨èä½¿ç”¨æ³¨è§£ã€‚

å¦‚æœä¸é‡‡ç”¨æ³¨è§£ï¼Œå®é™…å¯ä»¥é€šè¿‡æ¯”å¦‚å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ŒæŸ¥æ‰¾æ‰€æœ‰ç»§æ‰¿è¿™ä¸ªæ¥å£çš„å­ç±»ï¼Œç„¶åç”Ÿæˆä»£ç ã€‚ä½†å¹¶æ²¡æœ‰æ³¨è§£æ–¹ä¾¿ï¼Œå› ä¸ºæ³¨è§£å¯ä»¥æ›´å¥½åœ°è„±ç¦»ä»£ç æœ¬èº«ï¼Œç‹¬ç«‹æ€§æ›´å¼ºï¼Œè€Œä¸”æ³¨è§£å¯ä»¥é…ç½®å„ç§å‚æ•°ï¼Œå¦‚æœé‡‡ç”¨å®šä¹‰æ¥å£è¿™ç±»æ–¹å¼å°±ä¸æ–¹ä¾¿è®¾ç½®å‚æ•°äº†ã€‚

## 3. KSPå‚æ•°
ä½¿ç”¨KSPå¯ä»¥è®¾ç½®å‚æ•°ï¼Œé€šè¿‡ SymbolProcessorEnvironment.options å¯ä»¥è·å–åˆ°å®ƒä»¬
```
ksp {
    arg("option1", "value1")
    arg("option2", "value2")
    ...
}
```
```
class MySymbolProcessorProvider : SymbolProcessorProvider {
    override fun create(environment: SymbolProcessorEnvironment): SymbolProcessor {
        val option1 = environment.options["option1"]
        val option2 = environment.options["option2"]
        // ......
    }
}
```

## 4. å¤šå¹³å°
å¤šå¹³å°æš‚æœªå…³æ³¨ğŸ˜…

## 5. APIè®¾è®¡
å¼€å‘ä¸€ä¸ªKSPå·¥å…·ï¼Œç”¨äºç”Ÿæˆä»£ç ï¼Œäº†è§£ä½¿ç”¨æµç¨‹å’Œç›¸å…³çš„ä½¿ç”¨ç»†èŠ‚ä¹‹åï¼Œå…¶å®æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚æ›´é‡è¦çš„æ˜¯å¦‚ä½•è®¾è®¡APIï¼Œæä¾›ä¸€ä¸ªç®€å•ä¼˜é›…çš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™éœ€è¦æ›´å¤šçš„æ€è€ƒå’Œå®è·µéªŒè¯ã€‚

## 6. æµ‹è¯•
å¯ç”¨äºKSPçš„æµ‹è¯•æ¡†æ¶
https://github.com/tschuchortdev/kotlin-compile-testing

## 7. Roomåº“å¼€å‘çš„APT/KSPä¸­é—´å±‚
ä¸ºäº†é¿å…åŒæ—¶æ”¯æŒkaptã€kspè¦ç»´æŠ¤ä¸¤å¥—ä»£ç ï¼Œroomåšäº†ä¸ªä¸­é—´å±‚
androidx.room:room-compiler-processing